<div class="main-content" id="app">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-12">

            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Diseases</h4>
                    </div>
                    <div class="card-content ">
                        <div class="card-body card-dashboard">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                    data-target="#tr_modal" id="new_disease">
                                Добавить
                            </button>
                            <div class="modal fade text-left" id="tr_modal" tabindex="-1" role="dialog"
                                 aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title" id="myModalLabel1">Disease</h4>
                                            <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <form id="disease_form">
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label for="disease_name">Name</label>
                                                    <input type="text" id="disease_name" class="form-control" name="disease_name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="disease_name_russian">Name Russian</label>
                                                    <input type="text" id="disease_name_russian" class="form-control" name="disease_name_russian">
                                                </div>
                                                <div class="form-group">
                                                    <label for="disease_name_russian_old">Mutation</label>
                                                    <input type="text" id="disease_name_russian_old" class="form-control" name="disease_name_russian_old">
                                                </div>
                                                <div class="form-group">
                                                    <label for="disease_name_russian_old">Category</label>
                                                    <select id="category_id" class="form-control">
                                                        <option value="0">Choose category</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="disease_name_russian_old">Group</label>
                                                    <select id="group_id" class="form-control" name="group_id">
                                                        <option value="0">Choose group</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn grey btn-outline-secondary"
                                                        data-dismiss="modal">Close
                                                </button>
                                                <button type="submit" class="btn btn-outline-primary">Save changes
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <table width="100%" id="diseases" class="table table-striped table-bordered file-export">
                                <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Name russian</th>
                                    <th>Mutation</th>
                                    <th>Group</th>
                                    <th>Category</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Disease categories</h4>
                    </div>
                    <div class="card-content ">
                        <div class="card-body card-dashboard">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                    data-target="#tr_modal_category" id="new_category">
                                Добавить
                            </button>
                            <div class="modal fade text-left" id="tr_modal_category" tabindex="-1" role="dialog"
                                 aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title" id="myModalLabel1">Disease category</h4>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <form id="disease_category_form">
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label for="disease_name">Category name</label>
                                                    <input type="text" id="category_name" class="form-control" name="category_name">
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn grey btn-outline-secondary"
                                                        data-dismiss="modal">Close
                                                </button>
                                                <button type="submit" class="btn btn-outline-primary">Save changes
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <table width="100%" id="disease_categories" class="table table-striped table-bordered file-export">
                                <thead>
                                <tr>
                                    <th>Category name</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Disease groups</h4>
                    </div>
                    <div class="card-content ">
                        <div class="card-body card-dashboard">
                            <div class="form-group">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                        data-target="#tr_modal_group" id="new_group">
                                    Добавить
                                </button>
                                <div class="modal fade text-left" id="tr_modal_group" tabindex="-1" role="dialog"
                                     aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="myModalLabel1">Disease group</h4>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form id="disease_group_form">
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <label for="group_name">Group name</label>
                                                        <input type="text" id="group_name" class="form-control" name="group_name">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="group_name">Disease category</label>
                                                        <select type="text" id="group_category_id" class="form-control" name="category_id">
                                                            <option value="0">Choose category</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn grey btn-outline-secondary"
                                                            data-dismiss="modal">Close
                                                    </button>
                                                    <button type="submit" class="btn btn-outline-primary">Save changes
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <table width="100%" id="disease_groups" class="table table-striped table-bordered file-export">
                                    <thead>
                                    <tr>
                                        <th>Group name</th>
                                        <th>Category</th>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        let Categories = {}, Groups = {}, GroupsCategories = {}, CategoriesGroups = {}, DiseasesById = {},
            diseaseId = 0, categoryId = 0, groupId = 0
        $.post({
            url: '/diseaseCategory/getAll'
        }).then(data => {
            let CategoriesDB = JSON.parse(data)
            CategoriesDB.result.forEach(cat => {
                Categories[cat.id] = cat.category_name
                $("#category_id, #group_category_id").append(`<option value="${cat.id}">${cat.category_name}</option>`);
                $("#disease_categories tbody").append(`<tr id="catrow_${cat.id}" class="catdbrow">
                    <td>${cat.category_name}</td>
                </tr>`)
            })
            $("#disease_categories").dataTable({
                drawCallback: () => {
                    $(".catdbrow").dblclick(e => {
                        let id = $(e.currentTarget).attr('id').split('_')[1]
                        categoryId = id
                        $("#category_name").val(Categories[id])
                        $("#tr_modal_category").modal('show')
                    })
                }
            })
            $.post({
                url: '/diseaseGroup/getAll'
            }).then(data => {
                let GroupsDB = JSON.parse(data)
                GroupsDB.result.forEach(group => {
                    Groups[group.id] = group.group_name
                    GroupsCategories[group.id] = group.category_id
                    if (!Array.isArray(CategoriesGroups[group.category_id])) {
                        CategoriesGroups[group.category_id] = []
                    }
                    CategoriesGroups[group.category_id].push(group.id)
                    $("#disease_groups tbody").append(`<tr class='grouprow' id='group_${group.id}'>
                        <td>${group.group_name}</td>
                        <td>${Categories[group.category_id]}</td>
                    </tr>`)
                })
                $("#category_id").change(e => {
                    let CategoryChosen = $(e.currentTarget).val()
                    $("#group_id").html('<option value="0">Choose group</option>')
                    CategoriesGroups[CategoryChosen].forEach(group_id => {
                        $("#group_id").append(`<option value="${group_id}">${Groups[group_id]}</option>`)
                    })
                });
                $("#disease_groups").dataTable({
                    drawCallback: () => {
                        $(".grouprow").dblclick(e => {
                            let id = $(e.currentTarget).attr('id').split('_')[1]
                            groupId = id
                            $("#group_name").val(Groups[id])
                            $("#group_category_id").val(GroupsCategories[id])
                            $("#tr_modal_group").modal('show')
                        })
                    }
                });
                $.post({
                    url: '/disease/getAll'
                }).then(data => {
                    let Diseases = JSON.parse(data)
                    Diseases.result.forEach(disease => {
                        $("#diseases tbody").append(`<tr id="row_${disease.id}" class="dbrow">
                            <td>${disease.disease_name}</td>
                            <td>${disease.disease_name_russian}</td>
                            <td>${disease.disease_name_russian_old}</td>
                            <td>${Groups[disease.group_id]}</td>
                            <td>${Categories[GroupsCategories[disease.group_id]]}</td>
                        </tr>`)
                        DiseasesById[disease.id] = {
                            disease_name: disease.disease_name,
                            disease_name_russian: disease.disease_name_russian,
                            disease_name_russian_old: disease.disease_name_russian_old,
                            group_id: disease.group_id
                        }
                    })
                    $("#diseases").dataTable({
                        drawCallback: () => {
                            $(".dbrow").dblclick(e => {
                                let id = $(e.currentTarget).attr('id').split('_')[1]
                                diseaseId = id
                                $("#disease_name").val(DiseasesById[id].disease_name)
                                $("#disease_name_russian").val(DiseasesById[id].disease_name_russian)
                                $("#disease_name_russian_old").val(DiseasesById[id].disease_name_russian_old)
                                $("#category_id").val(GroupsCategories[DiseasesById[id].group_id])
                                $("#group_id").html('<option value="0">Choose group</option>')
                                CategoriesGroups[GroupsCategories[DiseasesById[id].group_id]].forEach(group_id => {
                                    $("#group_id").append(`<option value="${group_id}">${Groups[group_id]}</option>`)
                                })
                                $("#group_id").val(DiseasesById[id].group_id)
                                $("#tr_modal").modal('show')
                            })
                        }
                    })
                })
            })
        })


        $("#disease_form").submit(e => {
            e.preventDefault()
            let disease_name = $("#disease_name").val(),
                disease_name_russian =  $("#disease_name_russian").val(),
                disease_name_russian_old =  $("#disease_name_russian_old").val(),
                group_id =  $("#group_id").val(),
                data = {disease_name, disease_name_russian, disease_name_russian_old, group_id}
            if (diseaseId !== 0) {
                data.id = diseaseId
            }
            if (group_id === '0') {
                toastr.error('Выберите группу')
            } else {
                $.post({
                    url: 'disease/save',
                    data: data
                }).then(res => {
                    location.reload()
                })
            }
        })

        $("#new_disease").click(() => {
            diseaseId = 0
            $("#disease_name, #disease_name_russian, #disease_name_russian_old").val('')
            $("#category_id, #group_id").val(0)
        })


        $("#disease_category_form").submit(e => {
            e.preventDefault()
            let category_name = $("#category_name").val(),
                data = {category_name}
            if (categoryId !== 0) {
                data.id = categoryId
            }
            $.post({
                url: 'diseaseCategory/save',
                data: data
            }).then(res => {
                location.reload()
            })
        })

        $("#new_category").click(() => {
            categoryId = 0
            $("#category_name").val('')
        })


        $("#disease_group_form").submit(e => {
            e.preventDefault()
            let group_name = $("#group_name").val(), category_id = $("#group_category_id").val(),
                data = {group_name, category_id}
            if (groupId !== 0) {
                data.id = groupId
            }
            $.post({
                url: 'diseaseGroup/save',
                data: data
            }).then(res => {
                location.reload()
            })
        })

        $("#new_group").click(() => {
            groupId = 0
            $("#category_name").val('')
            $("#group_category_id").val(0)
        })


    })

</script>
