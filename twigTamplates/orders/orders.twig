<div class="main-content" id="app">
    <div class="content-wrapper"><!--Statistics cards Starts-->
        <!--Statistics cards Ends-->

        <!--Line with Area Chart 1 Starts-->

        <section id="file-export">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">FR table</h4>
                        </div>
                        <div class="card-content ">
                            <div class="card-body card-dashboard ">

                                {% if role == '2' or role == '7' %}

                                {% else %}
                                    <a href="../orders/add" class="btn btn-success btn-sm">
                                        Добавить заявку
                                    </a>
                                {% endif %}


                                <div class="form-group">
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                            data-target="#tr_modal">
                                        Настройки
                                    </button>

                                    <div class="modal fade text-left" id="tr_modal" tabindex="-1" role="dialog"
                                         aria-labelledby="myModalLabel1"
                                         aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h4 class="modal-title" id="myModalLabel1">TR Настройки</h4>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Отметьте нужные</h5>

                                                    <input type="checkbox" checked id="actions" class="toggle-vis"
                                                           data-column="1"/><span class="ml-1">Actions</span><br>
                                                    <input type="checkbox" checked id="fr_date" class="toggle-vis"
                                                           data-column="2"/><span class="ml-1">Date</span><br>
                                                    <input type="checkbox" checked id="linked_fr_id"
                                                           class="toggle-vis" data-column="3"/><span
                                                            class="ml-1">linked</span><br>
                                                    <input type="checkbox" checked id="internal_id" class="toggle-vis"
                                                           data-column="4"/><span class="ml-1">internal</span><br>
                                                    <input type="checkbox" checked id="external_id" class="toggle-vis"
                                                           data-column="5"/><span class="ml-1">external</span><br>
                                                    <input type="checkbox" checked id="project_name"
                                                           class="toggle-vis" data-column="6"/><span class="ml-1">project name</span><br>
                                                    <input type="checkbox" checked id="project_details"
                                                           class="toggle-vis" data-column="7"/><span class="ml-1">original text</span><br>
                                                    <input type="checkbox" checked id="comments" class="toggle-vis"
                                                           data-column="8"/><span class="ml-1">comments</span><br>
                                                    <input type="checkbox" checked id="feas_russian"
                                                           class="toggle-vis" data-column="9"/><span class="ml-1">russian text</span><br>
                                                    <input type="checkbox" checked id="fr_status" class="toggle-vis"
                                                           data-column="10"/><span class="ml-1">status</span><br>
                                                    <input type="checkbox" checked id="fr_status_date"
                                                           class="toggle-vis" data-column="11"/><span class="ml-1">status date</span><br>


                                                    <input type="checkbox" checked id="clinical_inclusion"
                                                           class="toggle-vis" data-column="13"/><span class="ml-1">specific feature</span><br>
                                                    <input type="checkbox" checked id="answering_id"
                                                           class="toggle-vis" data-column="14"/><span
                                                            class="ml-1">user</span><br>
                                                    <input type="checkbox" checked id="script_number"
                                                           class="toggle-vis" data-column="16"/><span
                                                            class="ml-1">script number</span><br>

                                                    <input type="checkbox" checked id="priority" class="toggle-vis"
                                                           data-column="17"/><span class="ml-1">priority</span><br>

                                                    <input type="checkbox" checked id="deadline" class="toggle-vis"
                                                           data-column="18"/><span class="ml-1">NBS Deadline</span><br>

                                                    <input type="checkbox" checked id="value_mount" class="toggle-vis"
                                                           data-column="19"/><span class="ml-1">Quote mount</span><br>

                                                    <input type="checkbox" checked id="deadline_post" class="toggle-vis"
                                                           data-column="20"/><span class="ml-1">Delivery Deadline</span><br>


                                                    <input type="checkbox" checked id="deadline_quote"
                                                           class="toggle-vis"
                                                           data-column="21"/><span class="ml-1">Proposal Deadline</span><br>

                                                    <input type="checkbox" checked id="status_client"
                                                           class="toggle-vis"
                                                           data-column="22"/><span class="ml-1">Клиент</span><br>


                                                    <input type="checkbox" checked id="status_manager"
                                                           class="toggle-vis"
                                                           data-column="23"/><span class="ml-1">Сайт Сайт менеджеры</span><br>

                                                    <input type="checkbox" checked id="status_project"
                                                           class="toggle-vis"
                                                           data-column="24"/><span class="ml-1">Проектный отдел</span><br>

                                                    <input type="checkbox" checked id="status_lpo"
                                                           class="toggle-vis"
                                                           data-column="25"/><span class="ml-1">ЛТО</span><br>


                                                    <input type="checkbox" checked id="status_ved"
                                                           class="toggle-vis"
                                                           data-column="26"/><span class="ml-1">Отдел ВЭД</span><br>

                                                    <input type="checkbox" checked id="status_boss"
                                                           class="toggle-vis"
                                                           data-column="27"/><span class="ml-1">Руководство</span><br>

                                                    <hr>

                                                    <input type="checkbox" checked id="attention_to"
                                                           class="toggle-vis"
                                                           data-column="28"/><span class="ml-1">attention to</span><br>

                                                    <hr>

                                                    Fr status
                                                </div>
                                                <div class="modal-footer">
                                                    {#                                                    <button type="button" class="btn grey btn-outline-secondary"#}
                                                    {#                                                            data-dismiss="modal">Close#}
                                                    {#                                                    </button>#}
                                                    {#                                                    <button type="button" class="btn btn-outline-primary">Save changes#}
                                                    {#                                                    </button>#}
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="modal fade text-left" id="new_ticket_modal" tabindex="-1" role="dialog"
                                         aria-labelledby="myModalLabel2"
                                         aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <input type="hidden" id="contact_id">
                                                <div class="modal-header">
                                                    <h4 class="modal-title" id="myModalLabel2">Заявка</h4>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="form-group">
                                                                <label for="new_title">Тема</label>
                                                                <input id="new_title" type="text" class="form-control">
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <label for="new_manager">Менеджеры</label>
                                                            <select id='new_manager' multiple='multiple'></select>
                                                        </div>
                                                        <div class="col-12">
                                                            <br>
                                                            <label for="new_deadline">Срок</label>
                                                            <input id="new_deadline" type="date" class="form-control">
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="form-group">
                                                                <label for="new_message">Сообщение</label>
                                                                <textarea id="new_message" class="form-control"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn grey btn-outline-secondary"
                                                            data-dismiss="modal">Отмена
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary"
                                                            id="save_ticket">
                                                        Сохранить
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>


                                <div class="row mb-4">
                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_script">Компания</label>
                                        <select class="form-control" id="filter_script">
                                            <option value="0">Company Name</option>
                                            {% for item in script %}
                                                <option value="{{ item.script }}">
                                                    {{ item.company_name }} - {{ item.script }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

{#                                     Данное поле более не используется , но осталось в скиптах фильтрации не убирать#}
                                    <div class="col-md-2 col-sm-12" style="display: none;">
                                        <label for="filter_status">Статус</label>
                                        <select class="form-control" id="filter_status">
                                            <option value="0">Status</option>
                                            {% for item in status %}
                                                <option value="{{ item.fr_status_values }}">{{ item.fr_status_values }} </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_users">Ответственный</label>
                                        <select class="form-control" id="filter_users">
                                            <option value="0">Users</option>
                                            {% for item in users %}
                                                <option value="{{ item.id }}">{{ item.lasttname }} {{ item.firstname }} {{ itempatronymic }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>


                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_deadline">Крайний срок</label>
                                        <input type="date" class="form-control" id="filter_deadline">
                                    </div>


                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_client">Клиент</label>
                                        <select class="form-control" id="filter_client">
                                            <option value="0">Клиент</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 7 %}
                                                    <option value="{{ item.status_name }}"
                                                        {% if department_id == 11 and item.status_name == 'ПО получено' %}
                                                            selected
                                                        {% endif %} >{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_manager">Сайт менеджеры</label>

                                        <select class="form-control" id="filter_manager">
                                            <option value="0">Сайт менеджеры</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 2 %}
                                                    <option value="{{ item.status_name }}">{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_project">Проектный отдел</label>

                                        <select class="form-control" id="filter_project">
                                            <option value="0">Проектный отдел</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 3 %}
                                                    <option value="{{ item.status_name }}">{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_lpo">ЛТО</label>

                                        <select class="form-control" id="filter_lpo">
                                            <option value="0">ЛТО</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 4 %}
                                                    <option value="{{ item.status_name }}">{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>


                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_ved">Отдел ВЭД</label>
                                        <select class="form-control" id="filter_ved">
                                            <option value="0">Отдел ВЭД</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 5 %}
                                                    <option value="{{ item.status_name }}">{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>


                                    <div class="col-md-2 col-sm-12">
                                        <label for="filter_boss">Руководство</label>
                                        <select class="form-control" id="filter_boss">
                                            <option value="0">Руководство</option>
                                            {% for item in orstatus %}
                                                {% if item.department_id == 6 %}
                                                    <option value="{{ item.status_name }}">{{  item.status_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>

                                </div>

{#                                <form action="exel/export" method="POST" id="vedomost_excel_form">#}

{#                                    <input type="hidden" id="excel_tbody" name="table">#}
{#                                </form>#}
{#                                <button class="btn btn-dark" id="vedomost_excel"><span style="color: red">new</span>#}
{#                                    Exel#}
{#                                </button>#}


                                <input type="hidden" id="mail_tbody" name="table">


                                <div class="row" style="margin-bottom: 25px">
                                    <div class="col-md-4 col-sm-12">
                                        <label for="">Дата с</label>
                                        <input type="date" class="form-control"
                                            {% if department_id == 11 %}
                                                value="1970-01-01"
                                            {% else %}
                                                value="{{ dateTwo }}"
                                            {% endif %}
                                               id="dateTwo">

                                    </div>
                                    <div class="col-md-4 col-sm-12">
                                        <label for="">Дата по</label>
                                        <input type="date" class="form-control" value="{{ dateOne }}" id="dateOne" >
                                    </div>

                                    <div class="col-md-4 col-sm-12">
                                        <div class="align-middle">
                                            <label for="reset_filter">Сбросить фильтр</label><br>
                                            <button class="btn btn-dark" id="reset_filter">Сбросить фильтр</button>
                                        </div>

                                    </div>
                                    <br>
                                    <br>
                                </div>

                                <div id='to_excel' style='max-width: 100%;' >
{#                                    <div class="wrapper-table__scrolled">#}
                                    <div class="">
                                        <table class="table table-striped table-bordered file-export table_scrolled" id="datatable_fr"
                                               border="1">
                                            <thead>
                                            <tr>
                                                <th>Task</th>
                                                <th>Actions</th>
                                                <th>Date</th>
                                                <th>linked fr id</th>
                                                <th>internal id</th>
                                                <th>external id</th>
                                                <th>project name</th>
                                                <th>Original text</th> <!--  project details-->
                                                <th>comments</th>
                                                <th>Russian text</th>
                                                <th>status</th>
                                                <th>status date</th>
                                                <th>Currency</th>
                                                <th>Specific feature</th>
                                                <th>User</th>
                                                <th>User id</th>
                                                <th>script number</th>
                                                <th>priority</th>
                                                <th>NBS Deadline</th>
                                                <th>Quote mount</th>
                                                <th>Delivery Deadline</th>
                                                <th>Proposal Deadline</th>
                                                <th>Клиент</th>
                                                <th>Сайт менеджеры</th>
                                                <th>Проектный отдел</th>
                                                <th>ЛТО</th>
                                                <th>Отдел ВЭД</th>
                                                <th>Руководство</th>
                                                <th>Attention to</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                            <tfoot>
                                            <tr>
                                                <th>Task</th>
                                                <th>Actions</th>
                                                <th>Date</th>
                                                <th>linked fr id</th>
                                                <th>internal id</th>
                                                <th>external id</th>
                                                <th>project</th>
                                                <th>Original text</th> <!--  project details-->
                                                <th>comments</th>
                                                <th>Russian text</th>
                                                <th>status</th>
                                                <th>status date</th>
                                                <th>Currency</th>
                                                <th>Specific feature</th>
                                                <th>User</th>
                                                <th>User id</th>
                                                <th>script number</th>
                                                <th>priority</th>
                                                <th>NBS Deadline</th>
                                                <th>Quote mount</th>
                                                <th>Delivery Deadline</th>
                                                <th>Proposal Deadline</th>
                                                <th>Клиент</th>
                                                <th>Сайт менеджеры</th>
                                                <th>Проектный отдел</th>
                                                <th>ЛТО</th>
                                                <th>Отдел ВЭД</th>
                                                <th>Руководство</th>
                                                <th>Attention to</th>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--Line with Area Chart 1 Ends-->
    </div>
</div>

<script src="../../../app-assets/js/jquery.multi-select.js"></script>
<script src="../../../app-assets/js/jquery.quicksearch.js"></script>
{#<script src="https://cdn.tiny.cloud/1/71j1qczmxow9ec79z0b3tz3q6rzzsq933b2rxwuc2lgjyxlu/tinymce/5/tinymce.min.js"#}
{#        referrerpolicy="origin"></script>#}
{#<script>tinymce.init({#}
{#        selector: 'textarea',#}
{#        height : "480"#}
{#    });</script>#}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let newTicketOrderId

        $("#vedomost_excel").click(() => {
            $("#excel_tbody").val($('<div>').append($("#to_excel").clone()).html());
            $("#vedomost_excel_form").submit();
        });

        socket.on('reloadFrTableUsers', (data) => {
            if (data.users_id == user_id) {
                datatable_fr.ajax.reload();
            }
        })

        if (window.localStorage) {
            // вытаскиваем filter_script из сессии
            let filter_script_session = localStorage.getItem('filter_script');
            if (filter_script_session) {
                $('#filter_script').val(filter_script_session)
            }
            let filter_status_session = localStorage.getItem('filter_status');
            if (filter_status_session) {
                $('#filter_status').val(filter_status_session)
            }
            let filter_users_session = localStorage.getItem('filter_users');
            if (filter_users_session) {
                $('#filter_users').val(filter_users_session)
            }
            let filter_deadline_session = localStorage.getItem('filter_deadline');
            if (filter_deadline_session) {
                $('#filter_deadline').val(filter_deadline_session)
            }
            // Статус клиента
            let filter_client_session = localStorage.getItem('filter_client');
            if (filter_client_session) {
                $('#filter_client').val(filter_client_session)
            }
            // Статус менеджера
            let filter_manager_session = localStorage.getItem('filter_manager');
            if (filter_manager_session) {
                $('#filter_manager').val(filter_manager_session)
            }
            // Статус Проектный отдел
            let filter_project_session = localStorage.getItem('filter_project');
            if (filter_project_session) {
                $('#filter_project').val(filter_project_session)
            }
            // Статус lpo
            let filter_lpo_session = localStorage.getItem('filter_lpo');
            if (filter_lpo_session) {
                $('#filter_lpo').val(filter_lpo_session)
            }
            // Статус Отдел ВЭД
            let filter_ved_session = localStorage.getItem('filter_ved');
            if (filter_ved_session) {
                $('#filter_ved').val(filter_ved_session)
            }
            // Статус Отдел ВЭД
            let filter_boss_session = localStorage.getItem('filter_boss');
            if (filter_boss_session) {
                $('#filter_boss').val(filter_boss_session)
            }
        }

        if ($.fn.DataTable.isDataTable('#tblRemittanceList')) {
            $('#tblRemittanceList').DataTable().destroy();
        }
        let dateOne = document.getElementById('dateOne').value,
            dateTwo = document.getElementById('dateTwo').value,
            ManagerTaskModal = $("#new_ticket_modal"), TicketManagerSelect = $("#new_manager"),
            TicketDeadline = $("#new_deadline"), TicketTitle = $("#new_title")

        let datatable_fr = $('#datatable_fr').DataTable({
            "ajax": {
                url: `/orders/getOrdersAll/?dateOne=${dateOne}&dateTwo=${dateTwo}`,
                type: "POST"
            },
            dom: 'Bfrtip',
            buttons: [
                'excelHtml5',
            ],
            "columnDefs": [
                {
                    'targets': 0,
                    'data': 'proj_id',
                    /*visible: `{{ role }}` === '6',*/
                    'render': function (data, type, row, full, meta) {
                        return `<a class="btn btn-info managertask" id="managertask_${data}">Создать задачу</a>`;
                    }
                },
                {
                    'targets': 1,
                    'data': 'proj_id',
                    'render': function (data, type, row, full, meta) {
                        if (type === 'export') {
                            return `${data}_Открыть_`;
                        } else {
                            return `<a target="_blank" href="../../orders/info/?idFR=${data}" data-id='${data}' class='btn  btn-block btn-info pull-right'>${data}</a>`;
                        }
                    }
                },
                {
                    'targets': 2,
                    'data': 'fr_date',
                },
                {
                    'targets': 3,
                    'data': 'linked_fr_id'
                },
                {
                    'targets': 4,
                    'data': 'internal_id',
                    'render': function (data, type, row, full, meta) {
                        if (type === 'export') {
                            return `${row.proj_id}_Открыть_${data}`;
                        } else {
                            return `<a target="_blank" href="http://crm.i-bios.com/orders/info/?idFR=${row.proj_id}" >${data}</a>`;
                        }
                    }
                },
                {
                    'targets': 5,
                    'data': 'external_id',
                },
                {
                    'targets': 6,
                    'data': 'project_name',
                },
                {
                    'targets': 7,
                    'data': 'project_details',
                    'render': function (data, type, full, meta) {
                        return ` ${data}`;
                    }
                },
                {
                    'targets': 8,
                    'data': 'comments',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 9,
                    'data': 'feas_russian',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 10,
                    'data': 'fr_status',
                },
                {
                    'targets': 11,
                    'data': 'fr_status_date',
                },
                {
                    'targets': 12,
                    'data': 'currency',
                    'visible': false
                },
                {
                    'targets': 13,
                    'data': 'clinical_inclusion',
                },
                {
                    'targets': 14,
                    'data': 'answering_id',
                },
                {
                    'targets': 15,
                    'data': 'users_id',
                    'visible': false
                },
                {
                    'targets': 16,
                    'data': 'script_number'

                },
                {
                    'targets': 17,
                    'data': 'priority',
                    'render': function (data, type, full, meta) {

                        return `${data}`;

                    }
                },
                {
                    'targets': 18,
                    'data': 'deadline',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 19,
                    'data': 'value_mount',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 20,
                    'data': 'deadline_post',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 21,
                    'data': 'deadline_quote',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 22,
                    'data': 'status_client',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 23,
                    'data': 'status_manager',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 24,
                    'data': 'status_project',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 25,
                    'data': 'status_lpo',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 26,
                    'data': 'status_ved',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 27,
                    'data': 'status_boss',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                },
                {
                    'targets': 28,
                    'data': 'attention_to',
                    'render': function (data, type, full, meta) {
                        return `${data}`;
                    }
                }

            ],
            language: {
                sLoadingRecords: '<span style="width:100%;"><img src="../app-assets/img/loaders/rolling.gif" alt="loading"></span>',
            },
            initComplete: function (settings, json) {
                let btns = document.querySelectorAll('i'),  clipboard = new ClipboardJS(btns)
                clipboard.on('success', function (e) {
                    toastr.info('Данные скопированы');
                })
                clipboard.on('error', function (e) {
                    toastr.error('Ошибка копирования');
                })
                let loadheck = () => {
                    let array = [
                        'actions', 'fr_date', 'linked_fr_id', 'internal_id', 'external_id',
                        'project_name', 'project_details', 'comments', 'feas_russian', 'fr_status',
                        'fr_status_date', 'clinical_inclusion', 'answering_id', 'script_number', 'priority',
                        'deadline', 'value_mount', 'deadline_post', 'deadline_quote', 'status_client',
                        'status_manager', 'status_project', 'status_lpo', 'status_boss', 'status_ved',
                        'attention_to'
                    ];
                    array.forEach(el => {
                        let check = localStorage.getItem(`orders_${el}`);
                        if (check === 'false' && document.getElementById(`${el}`))
                            document.getElementById(`${el}`).click();
                    })
                }
                loadheck();
                $(".managertask").off('click').click(e => {
                    newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                    ManagerTaskModal.modal('show')
                })
                $.get({ url: '/users/getManagers/' }).done(man_res => {
                    let Managers = JSON.parse(man_res)
                    Managers.result.forEach(Man => {
                        let FullName = `${Man.firstname} ${Man.lasttname} ${Man.patronymic ? Man.patronymic : ''}`
                        TicketManagerSelect.append(`<option value="${Man.id}">${FullName}</option>`)
                    })
                    TicketManagerSelect.multiSelect({
                        cssClass: 'selector-container',
                        selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Поиск'>",
                        selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Поиск'>",
                        afterInit: function(ms) {
                            let that = this,
                                $selectableSearch = that.$selectableUl.prev(),
                                $selectionSearch = that.$selectionUl.prev(),
                                selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                                selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';
                            that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                                .on('keydown', function(e){
                                    if (e.which === 40){
                                        that.$selectableUl.focus();
                                        return false;
                                    }
                                });
                            that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                                .on('keydown', function(e){
                                    if (e.which == 40){
                                        that.$selectionUl.focus();
                                        return false;
                                    }
                                });
                        }
                    })
                })
                let nextDay = new Date()
                nextDay.setDate(nextDay.getDate() + 2)
                let dd = nextDay.getDate(), mm = nextDay.getMonth() + 1, yyyy = nextDay.getFullYear(),
                    dateVal
                mm = mm > 9 ? mm : '0' + mm
                dd = dd > 9 ? dd : '0' + dd
                dateVal = `${yyyy}-${mm}-${dd}`
                TicketDeadline.val(dateVal)
                // WORST CALLBACK EVER
            },
            fnRowCallback: function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                if (aData.priority === "Важно") {
                    $('td', nRow).css('background-color', '#ffadad');
                } else {
                    $('td', nRow).css('background-color', '#fff');
                }
            },
            drawCallback: function(settings) {
                $(".managertask").off('click').click(e => {
                    newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                    ManagerTaskModal.modal('show')
                })
            },
        });

        $("#dateTwo").change(() => {
            let dateOne = document.getElementById('dateOne').value;
            let dateTwo = document.getElementById('dateTwo').value;
            datatable_fr.ajax.url(`/orders/getOrdersAll/?dateOne=${dateOne}&dateTwo=${dateTwo}`).load();
            $(".managertask").off('click').click(e => {
                newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                ManagerTaskModal.modal('show')
            })
        });
        $("#dateOne").change(() => {
            let dateOne = document.getElementById('dateOne').value;
            let dateTwo = document.getElementById('dateTwo').value;
            datatable_fr.ajax.url(`/orders/getOrdersAll/?dateOne=${dateOne}&dateTwo=${dateTwo}`).load();
            $(".managertask").off('click').click(e => {
                newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                ManagerTaskModal.modal('show')
            })
        });
        $('#reset_filter').click(function () {
            $('#dateTwo').val('1970-01-01');
            let dateOne = document.getElementById('dateOne').value;
            let dateTwo = document.getElementById('dateTwo').value;
            datatable_fr.ajax.url(`/orders/getOrdersAll/?dateOne=${dateOne}&dateTwo=${dateTwo}`).load();
            $(".managertask").off('click').click(e => {
                newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                ManagerTaskModal.modal('show')
            })
        });

        let initRole = (datatable_fr) => {
            let role = `{{ role }}`;
            if (role == 2) {
                datatable_fr.MakeCellsEditable({
                    "onUpdate": rowEditedCallback,
                    "columns": [16],
                    "inputTypes": [
                        {
                            "column": 16,
                            "type": "list",
                            "options": [
                                { 'value': 'Не определен', 'display': 'Не определен' },
                                { 'value': 'Важно', 'display': 'Важно' }
                            ]
                        }]
                });
            }
        }

        initRole(datatable_fr);

        $('.toggle-vis').on('click', function (e) {
            let column_name = e.target.id;
            let checked = e.target.checked;
            if(checked === true){
                checked = 'true'
            } else {
                checked = 'false'
            }
            localStorage.setItem(`orders_${column_name}`, checked);
            let column = datatable_fr.column($(this).attr('data-column'));
            column.visible(!column.visible());
        });

        // Функция фильтраци (условие для script)
        let checkScript = (search, text) => {
            if (search == 0) {
                return true;
            } else {
                let tr = text.split('-')
                if (tr[0] == search) {
                    return true;
                }
            }
            return false;
        }
        // Функция фильтрации (Условия для Статуса )
        let checkStatus = (search, text) => {
            if (search == 0) {
                return true;
            } else {
                if (search == text) {
                    return true;
                }
            }
            return false;
        }
        let checkUsers = (search, text) => {
            if (search == 0) {
                return true;
            } else {
                if (search == text) {
                    return true;
                }
            }
            return false;
        }
        let checkDate = (search, text) => {
            if (search == '') {
                return true;
            } else {
                if (search == text) {
                    return true;
                }
            }
            return false;
        }
        let checkAll = (search, text) => {
            if (search == 0) {
                return true;
            } else {
                if (search == text) {
                    return true;
                }
            }
            return false;
        }

        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                let filter_script = $('#filter_script').val();
                let filter_status = $('#filter_status').val();
                let filter_users = $('#filter_users').val();
                let filter_deadline = $('#filter_deadline').val();
                // фильтрация по статусам
                let filter_client = $('#filter_client').val();
                let filter_manager = $('#filter_manager').val();
                let filter_project = $('#filter_project').val();
                let filter_lpo = $('#filter_lpo').val();
                let filter_ved = $('#filter_ved').val();
                let filter_boss = $('#filter_boss').val();
                let checkScriptBoolean = false;
                let checkStatusBoolean = false;
                let checkUsersBoolean = false;
                let checkDeadLineBoolean = false;
                // фильтрация по статусам
                let checkClientBoolean = false;
                let checkManagerBoolean = false;
                let checkProjectBoolean = false;
                let checkLpoBoolean = false;
                let checkVedBoolean = false;
                let checkBossBoolean = false;
                if (checkScript(filter_script, data[4]))
                    checkScriptBoolean = true;
                if (checkStatus(filter_status, data[10]))
                    checkStatusBoolean = true;
                if (checkUsers(filter_users, data[15]))
                    checkUsersBoolean = true;
                if (checkDate(filter_deadline, data[18]))
                    checkDeadLineBoolean = true;
                if (checkAll(filter_client, data[22]))
                    checkClientBoolean = true;
                if (checkAll(filter_manager, data[23]))
                    checkManagerBoolean = true;
                if (checkAll(filter_project, data[24]))
                    checkProjectBoolean = true;
                if (checkAll(filter_lpo, data[25]))
                    checkLpoBoolean = true;
                if (checkAll(filter_ved, data[26]))
                    checkVedBoolean = true;
                if (checkAll(filter_boss, data[27]))
                    checkBossBoolean = true;
                $(".managertask").off('click').click(e => {
                    newTicketOrderId = $(e.currentTarget).attr('id').split('_')[1]
                    ManagerTaskModal.modal('show')
                })
                return checkScriptBoolean
                    && checkStatusBoolean
                    && checkUsersBoolean
                    && checkDeadLineBoolean
                    && checkClientBoolean
                    && checkManagerBoolean
                    && checkProjectBoolean
                    && checkLpoBoolean
                    && checkVedBoolean
                    && checkBossBoolean;
            }
        );

        // Фильтрация по компании
        $('#filter_script').change(function (e) {
            datatable_fr.draw();
            let value = $('#filter_script').val();
            localStorage.setItem('filter_script', value);
        });
        // filter_status
        $('#filter_status').change(function () {
            datatable_fr.draw();
            let value = $('#filter_status').val();
            localStorage.setItem('filter_status', value);

        });
        $('#filter_users').change(function () {
            datatable_fr.draw();
            let value = $('#filter_users').val();
            localStorage.setItem('filter_users', value);
        });
        $('#filter_deadline').change(function () {
            datatable_fr.draw();
            let value = $('#filter_deadline').val();
            localStorage.setItem('filter_deadline', value);
        });
        $('#filter_client').change(function () {
            datatable_fr.draw();
            let value = $('#filter_client').val();
            localStorage.setItem('filter_client', value);
        });
        $('#filter_manager').change(function () {
            datatable_fr.draw();
            let value = $('#filter_manager').val();
            localStorage.setItem('filter_manager', value);
        });
        $('#filter_project').change(function () {
            datatable_fr.draw();
            let value = $('#filter_project').val();
            localStorage.setItem('filter_project', value);
        });
        $('#filter_lpo').change(function () {
            datatable_fr.draw();
            let value = $('#filter_lpo').val();
            localStorage.setItem('filter_lpo', value);
        });
        $('#filter_ved').change(function () {
            datatable_fr.draw();
            let value = $('#filter_ved').val();
            localStorage.setItem('filter_ved', value);
        });
        $('#filter_boss').change(function () {
            datatable_fr.draw();
            let value = $('#filter_boss').val();
            localStorage.setItem('filter_boss', value);
        });
        $("#save_ticket").click(() => {
            let author_id = `{{ user_id }}`, title = TicketTitle.val(), message = tinymce.get('new_message').getContent(),
                deadline = TicketDeadline.val(), reason = 'manager',
                data = { author_id, title, message, deadline, reason, order_id: newTicketOrderId },
                managers = TicketManagerSelect.val()
            managers.forEach(mId => {
                data.target_id = mId
                $.post({ url: '/newTickets/save/', data }).done(() => {
                    ManagerTaskModal.modal('hide')
                    TicketTitle.val('')
                    tinymce.get('new_message').setContent('')
                    let nextDay = new Date()
                    nextDay.setDate(nextDay.getDate() + 2)
                    let dd = nextDay.getDate(), mm = nextDay.getMonth() + 1, yyyy = nextDay.getFullYear(),
                        dateVal
                    mm = mm > 9 ? mm : '0' + mm
                    dd = dd > 9 ? dd : '0' + dd
                    dateVal = `${yyyy}-${mm}-${dd}`
                    TicketDeadline.val(dateVal)
                    TicketManagerSelect.multiSelect("refresh")
                })
            })
        })
    });

    let rowEditedCallback = (updatedCell, updatedRow, oldValue) => {
        let NewData = updatedRow.data();
        let DataCopy = Object.assign({}, NewData);
        let priority = 0;
        if (DataCopy.priority === 'Важно') {
            priority = 1;
        }
        $.ajax({
            url: "../orders/ChangePriority",
            method: "POST",
            'data': {
                id: DataCopy,
                proj_id: DataCopy.proj_id,
                priority: priority
            }
        }).done(res => {
            if (!DataCopy.users_id) {
                toastr.info('Приоритет установлен', 'Пользователь не задан');
            }
            socket.emit('eventPriority', DataCopy);
        });
    }


</script>
