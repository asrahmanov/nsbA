<div class="main-content" id="app">
    <div class="content-wrapper">
        <section id="file-export">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title"><h2>Информация по заявке </h2></h4>
                        </div>
                        <div class="card-content ">
                            <div class="card-body card-dashboard ">
                                <div class="row">
                                    <div class="col-md-6 col-sm-12">
                                        <h2>FR TABLE - {{ fr.proj_id }}</h2>

                                        <div class="form-group">
                                            <label for="fr_date"><b>FR date: </b></label>
                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                {{ fr.fr_date | raw }}
                                            {% else %}

                                                <input type="date" id="fr_date" class="form-control"
                                                       value="{{ fr.fr_date }}">
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="linked_fr_id"><b>Linked FR id: </b></label>
                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                {{ fr.linked_fr_id | raw }}
                                            {% else %}
                                                <input type="text" id="linked_fr_id" class="form-control"
                                                       value="{{ fr.linked_fr_id }}">
                                            {% endif %}
                                        </div>

                                        {% if role != '8' %}
                                            <div class="form-group">
                                                <label for="script_id"><b>Fr script id: </b></label>
                                                {% if role == '2' %}
                                                    {{ fr.script_id | raw }}
                                                    {% for item in company %}
                                                        {% if ( item.script_id == fr.fr_script_id) %}
                                                            {% if (role =='3' or role == '7' or role == '8') %}

                                                            {% else %}
                                                                {{ item.script }} - {{ item.company_name }} {{ item.last_script_num }}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {% if(role =='3' or role == '7') %}

                                                    {% else %}
                                                        <select class="form-control" id="fr_script_id">
                                                            <option value="0">Выберите компанию</option>
                                                            {% if(role =='3' and role == '7') %}

                                                            {% else %}
                                                                {% for item in company %}
                                                                    <option value="{{ item.script_id }}">{{ item.script }}
                                                                        - {{ item.company_name }} {{ item.last_script_num }}</option>
                                                                {% endfor %}
                                                            {% endif %}


                                                        </select>
                                                    {% endif %}


                                                {% endif %}
                                            </div>
                                            <div class="form-group">
                                                <label for="fr_attention_to"><b>Attention to: </b></label>
                                                {% if(role !='3' and role != '7') %}
                                                    <select class="form-control" id="fr_attention_to">
                                                        <option value="0">Веберите менеджера</option>
                                                    </select>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        <div class="form-group">
                                            <label for="external_id"><b>External id: </b></label>

                                            {% if role == '2'  or role == '8' %}
                                                {% if(role !='3' and role != '7') %}

                                                {% else %}
                                                    {{ fr.external_id | raw }}
                                                {% endif %}
                                            {% else %}

                                                <input type="text" id="external_id" class="form-control"
                                                       value="{{ fr.external_id }}">


                                            {% endif %}
                                        </div>

                                        {% if role != '8' %}
                                            <div class="form-group">
                                                <label for="script_number"><b>Script number</b></label>
                                                {% if role == '2' or role =='3' or role == '8' %}
                                                    {% if(role =='3' and role == '7') %}

                                                    {% else %}
                                                        {{ fr.script_number | raw }}
                                                    {% endif %}

                                                {% else %}
                                                    <input type="text" id="script_number" class="form-control"
                                                           value="{{ fr.script_number }}" disabled>

                                                {% endif %}
                                            </div>

                                            <div class="form-group">
                                                <label for="internal_id"><b>Internal id: </b></label>
                                                {% if role == '2' or role =='3' or role == '7'  or role == '8' %}

                                                    {% if(role =='3') %}

                                                    {% else %}
                                                        {{ fr.internal_id | raw }}
                                                    {% endif %}

                                                {% else %}
                                                    <input type="text" id="internal_id" class="form-control" disabled
                                                           value="{{ fr.internal_id }}">
                                                {% endif %}
                                            </div>
                                        {% endif %}


                                        <div class="form-group">
                                            <label for="project_name"><b>Project name</b></label>
                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                {{ fr.project_name | raw }}
                                            {% else %}
                                                <input type="text" id="project_name" class="form-control"
                                                       value="{{ fr.project_name }}">
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="fr_priority">Приоритет</label>
                                            <select class="form-control" id="fr_priority">
                                                <option value="5" {% if fr.priority == '5' %} selected {% endif %}>
                                                    Неважно
                                                </option>
                                                {# <option value="4" {% if fr.priority == '4' %} selected {% endif %}>4</option> #}
                                                {# <option value="3" {% if fr.priority == '3' %} selected {% endif %}>3</option> #}
                                                {# <option value="2" {% if fr.priority == '2' %} selected {% endif %}>2</option> #}
                                                <option value="1" {% if fr.priority == '1' %} selected {% endif %}>
                                                    Важно
                                                </option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="comments"><b>Comments</b></label>

                                            {% if role == '2'  or role == '8' or department_id == '4' %}
                                                <div class="minBlock">{{ fr.comments | raw }}</div>

                                            {% else %}
                                                <textarea id="comments" cols="30"
                                                          rows="15">{{ fr.comments }}</textarea>
                                            {% endif %}


                                        </div>


                                        <div class="form-group">
                                            <label for="feas_russian"><b>Request(Russian text)</b></label>

                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                <div class="minBlock">{{ fr.feas_russian | raw }}</div>
                                            {% else %}
                                                <textarea id="feas_russian" cols="30"
                                                          rows="15">{{ fr.feas_russian }}</textarea>
                                                <br>
                                                <button class="btn-dark btn"
                                                        onclick="sendNewInfo()">
                                                    <i
                                                            class="ft-rotate-cw"></i> Отправить информацию о изменениях
                                                </button>
                                            {% endif %}
                                        </div>

                                        {% if role != '3' and role != '8' %}
                                            <div class="form-group" style="display: none;">
                                                <label for="basicSelect">Fr status</label>
                                                <select class="form-control" id="fr_status_id" disabled>
                                                    <option value="0">Выберите статус</option>
                                                    {% for item in status %}
                                                        <option value="{{ item.fr_status_id }}">{{ item.fr_status_values }} </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        {% endif %}


                                        <div class="form-group">
                                            <label for="fr_date"><b>FR status_date</b></label>
                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                {{ fr.fr_status_date | raw }}
                                            {% else %}
                                                <input type="date" id="fr_status_date" class="form-control"
                                                       value="{{ fr.fr_status_date }}" name="fr_status_date"
                                                       data-toggle="tooltip"
                                                       data-trigger="hover" data-placement="top"
                                                       data-title="Date Opened" disabled>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="project_details"><b></br>Request(Original text)</b></label>
                                            {% if role == '2' or role == '3' or role == '7' or role == '8' %}
                                                <div class="minBlock">{{ fr.project_details | raw }}</div>
                                            {% else %}
                                                <textarea name="project_details" id="project_details" cols="30"
                                                          rows="15">{{ fr.project_details }}</textarea>
                                            {% endif %}
                                        </div>

                                        {% if role != '3' and role != '7'  and role != '8' %}
                                            <div class="form-group" style="display: none">
                                                <label for="currency">currency</label>
                                                <input type="text" id="currency" class="form-control"
                                                       value="{{ fr.currency }}">
                                            </div>
                                        {% endif %}

                                        {% if role != '8' %}
                                            <div class="form-group">
                                                <label for="clinical_inclusion">Specific feature</label>
                                                {% if role == '2' or role == '8' %}

                                                    <div class="minBlock">{{ fr.clinical_inclusion | raw }}</div>
                                                {% elseif role == '3' or role == '7' %}

                                                {% else %}
                                                    <textarea name="clinical_inclusion" id="clinical_inclusion"
                                                              cols="30"
                                                              rows="15">{{ fr.clinical_inclusion }}</textarea>

                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        <div class="form-group">
                                            <label for="project_details">Комментарий ЛТО</label>
                                            {% if role == '2' or  role == '6' or role == '1' or  department_id == '4' %}
                                                <textarea name="fr_lto_comment" id="fr_lto_comment" cols="30"
                                                          rows="15">{{ fr.lto_comment }}</textarea>
                                            {% else %}
                                                {# <div class="minBlock">{{ fr.lto_comment | raw }}</div> #}
                                            {% endif %}
                                        </div>
                                        <div class="form-group" style="display: none;">
                                            <label for="fr_po_comment">Комментарий Проектный отдел</label>
                                            {% if role == '2' or  role == '6' or role == '1' or  department_id == '4' %}
                                                <textarea name="fr_po_comment" id="fr_po_comment" cols="30"
                                                          rows="15">{{ fr.po_comment }}</textarea>
                                            {% else %}
                                                {# <div class="minBlock">{{ fr.po_comment | raw }}</div> #}
                                            {% endif %}
                                        </div>
                                    </div>


                                    <div class="col-md-6 col-sm-12">
                                        <h2>FR PRICE </h2>
                                        {% if role != '3' and role != '7'  and role != '8' %}
                                            <div class="form-group" style="display: none;">
                                                <label for="quote_date">Quote date</label>
                                                <input type="date" id="quote_date" class="form-control"
                                                       value="{{ fr.quote_date }}" name="quote_date"
                                                       data-toggle="tooltip"
                                                       data-trigger="hover" data-placement="top"
                                                       data-title="Date Opened">
                                            </div>
                                        {% endif %}

                                        {% if role != '8' %}
                                            <div class="form-group">
                                                <label for="unformal_quote">Historical Quotes</label>
                                                {% if role == '2' %}
                                                    <div class="minBlock">{{ fr.unformal_quote | raw }}</div>
                                                {% elseif role != '3' and role != '7' and role != '8' %}
                                                    <textarea id="unformal_quote" cols="30"
                                                              rows="15">{{ fr.unformal_quote }}</textarea>
                                                {% endif %}
                                            </div>
                                            <div class="form-group">
                                                <label for="history_po">Historical PO's</label>
                                                {% if role == '2' %}
                                                    <div class="minBlock">{{ fr.history_po | raw }}</div>
                                                {% elseif role != '3' and role != '7' and role != '8' %}
                                                    <textarea id="history_po" cols="30"
                                                              rows="15">{{ fr.history_po }}</textarea>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        {% if user_id != '32' and (role == '1' or role == '2' or role == '6') %}
                                            <div class="form-group">
                                                <label for="historical_data">Reminder comments</label>
                                                {% if role == '2' or role == '7' or role == '8' %}
                                                    <div class="minBlock">{{ fr.historical_data | raw }}</div>
                                                {% elseif role != '3' %}
                                                    <textarea id="historical_data" cols="30"
                                                              rows="15" {% if user_id != '32' %} disabled {% endif %}>
                                                        {{ fr.historical_data }}</textarea>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if role != '3' and role != '7'  and role != '8' %}
                                            <div class="form-group" style="display: none">
                                                <label for="quotes_from_managers">Quotes from managers</label>

                                                {% if role == '2' %}
                                                    <div>{{ fr.quotes_from_managers | raw }}</div>
                                                {% else %}
                                                    <textarea name="quotes_from_managers" id="quotes_from_managers"
                                                              cols="30"
                                                              rows="15">{{ fr.quotes_from_managers }}</textarea>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        <div class="form-group">
                                            <label for="basicSelect"><b>Responsible User: </b></label>
                                            {% if role == '2' or role=='3' or role == '7'  or role == '8' %}
                                                {% for item in users %}
                                                    {% if item.id == fr.answering_id %}
                                                        {{ item.firstname }} {{ item.lasttname }} {{ item.patronymic }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}

                                                <select class="form-control" id="answering_id">
                                                    <option value="0">Не закреплен</option>
                                                    {% for item in users %}
                                                        <option value="{{ item.id }}">{{ item.firstname }} {{ item.lasttname }} {{ item.patronymic }} </option>
                                                    {% endfor %}
                                                </select>

                                            {% endif %}
                                        </div>

                                        {% if role == '1' or role=='6' %}
                                            <div class="form-group">
                                                <label for="file-form">Прикрепить файлы</label>
                                                <form id="file-form" method="post">
                                                    <input id="file-input" type="file" multiple>
                                                    <label for="file_info"></label>
                                                    <select id="file_info" class="form-control">
                                                        <option value="none">Общий</option>
                                                        <option value="lto">ЛТО</option>
                                                        <option value="po">PO</option>
                                                        <option value="quote">Квоты</option>
                                                        <option value="manager">Файлы для менеджеров</option>
                                                        <option value="send">Файлы для отправки</option>
                                                    </select>
                                                    <br>
                                                    <button id="file-submit" type="button" class="btn btn-success">
                                                        Загрузить файлы
                                                    </button>
                                                    <br/>
                                                    <div id="file-container"></div>
                                                </form>
                                            </div>
                                            <div class="form-group">
                                                <label for="basicSelect">Файлы</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'none' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                               style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                               data-id="{{ item.id }}"></i>
                                                            <br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% elseif role=='2' %}
                                            <div class="form-group">
                                                <label for="basicSelect">Файлы</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'none' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank">{{ item.name }}</a><br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}


                                        {% if role == '1' or role=='6' %}
                                            <div class="form-group">
                                                <label for="basicSelect">Request related documents</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'lto' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                               style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                               data-id="{{ item.id }}"></i>
                                                            <br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% elseif role == '2' or department_id == '4' %}
                                            <div class="form-group">
                                                <label for="basicSelect">Request related documents</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'lto' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                               style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                               data-id="{{ item.id }}"></i>
                                                            <br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if role =='1' or role == '2' or role == '6' %}
                                            <div class="form-group">
                                                <label for="nothing">Файлы PO</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'po' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                               style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                               data-id="{{ item.id }}"></i>
                                                            <br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="nothing">Файлы квот</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'quote' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            {% if role == '1' or role == '6' %}
                                                                <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                                   style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                                   data-id="{{ item.id }}"></i>
                                                            {% endif %}
                                                            <br>

                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="nothing">Файлы Клиентов</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'clientsend' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            {% if role == '1' or role == '6' %}
                                                                <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                                   style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                                   data-id="{{ item.id }}"></i>
                                                            {% endif %}
                                                            <br>

                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if role == '1' or role == '3' or role == '6' or role == '8' %}
                                            <div class="form-group">
                                                <label for="basicSelect">Файлы для менеджеров</label>
                                                <div id="file_list">
                                                    {% for item in files %}
                                                        {% if item.info == 'manager' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            {% if role == '1' or role == '6' %}
                                                                <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                                   style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                                   data-id="{{ item.id }}"></i>
                                                                <br>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if role == '1' or role == '3' or role == '6' or role == '8' %}
                                            <div class="form-group">
                                                <label for="basicSelect">Файлы для отправки</label>
                                                <div>
                                                    {% for item in files %}
                                                        {% if item.info == 'send' %}
                                                            <a href="../../{{ item.alias }}{{ item.name }}"
                                                               target="_blank"
                                                               id="file_{{ item.id }}">{{ item.name }}</a>
                                                            {% if role == '1' or role == '6' %}
                                                                <i class="ft-delete deleteFile" id="btn_{{ item.id }}"
                                                                   style="color: red; font-size: 18px; margin-left: 10px; cursor: pointer;"
                                                                   data-id="{{ item.id }}"></i>
                                                                <br>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if role == '1'  or role=='6' %}

                                            <div class="form-group">
                                                <label for="nothing">Файлы для отправки в nbsPlatfors</label>
                                                <div id="file_list">
                                                    <div class="row">
                                                        <div class="col-8">

                                                            <select name="" id="fileQouteSend" class="form-control">
                                                                <option value="0">Выберите файл для отправки</option>
                                                                {% for item in files %}
                                                                    {% if item.info == 'quote' %}

                                                                        <option value="https://crm.i-bios.com/{{ item.alias }}{{ item.name }}"
                                                                                {% if ('https://crm.i-bios.com/' ~ item.alias ~ item.name) == fr.file_qoute_send %}
                                                                                    selected
                                                                                {% endif %}
                                                                        >{{ item.name }}</option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-4">
                                                            <button class="btn btn-success" id="send_fileQouteSend">
                                                                Отправить
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        {% endif %}


                                        <div class="form-group">
                                            <label for="deadline"><b>I-BIOSDeadline: </b></label>
                                            {% if role == '5'  or role=='3' or role == '7' or role == '8' %}

                                                {{ fr.deadline | raw }}
                                            {% else %}

                                                <input type="date" id="deadline" class="form-control"
                                                       value="{{ fr.deadline }}">
                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="deadline"><b>Delivery Deadline</b></label>
                                            {% if role == '5'  or role=='3' or role == '7' or role == '8' %}

                                                {{ fr.deadline_post | raw }}
                                            {% else %}
                                                <input type="date" id="deadline_post" class="form-control"
                                                       value="{{ fr.deadline_post }}">
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="deadline"><b>Proposal Deadline: </b></label>
                                            {% if role == '5'  or role=='3' or role == '7' or role == '8' %}

                                                {{ fr.deadline_quote | raw }}
                                            {% else %}

                                                <input type="date" id="deadline_quote" class="form-control"
                                                       value="{{ fr.deadline_quote }}">
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="communication_date"><b>Communication date: </b></label>
                                            {% if role == '5'  or role=='3' or role == '7' or role == '8' %}
                                                {{ fr.communication_date | raw }}
                                            {% else %}

                                                <input type="date" id="communication_date" class="form-control"
                                                       value="{{ fr.communication_date }}">
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="communication_comment"><b>Communication comment: </b></label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <textarea id="communication_comment"
                                                          class="form-control">{{ fr.communication_comment }}</textarea>
                                            {% elseif department_id == '4' %}
                                                {{ fr.communication_comment | raw }}
                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="status_client">Клиент: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_client">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 7 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_client == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}
                                                {% for item in orstatus %}
                                                    {% if item.department_id == 7 %}
                                                        {% if fr.status_client == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="status_client">Менеджер: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_manager">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 2 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_manager == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}
                                                {% for item in orstatus %}
                                                    {% if item.department_id == 2 %}
                                                        {% if fr.status_manager == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>


                                        <div class="form-group">

                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <button class="btn btn-info" onclick="addWork()">Отправить бибанкам
                                                </button>
                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="status_client">Проектный отдел: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_project">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 3 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_project == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}

                                                {% for item in orstatus %}
                                                    {% if item.department_id == 3 %}
                                                        {% if fr.status_project == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}

                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="status_client">ЛТО: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_lpo">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 4 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_lpo == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}

                                                {% for item in orstatus %}
                                                    {% if item.department_id == 4 %}
                                                        {% if fr.status_lpo == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}

                                            {% endif %}
                                        </div>


                                        <div class="form-group">
                                            <label for="status_client">Отдел ВЕД: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_ved">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 5 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_ved == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}

                                                {% for item in orstatus %}
                                                    {% if item.department_id == 5 %}
                                                        {% if fr.status_ved == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}

                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            <label for="status_client">Руководство: </label>
                                            {% if role == '1' or role == '6' or role == '2' %}
                                                <select class="form-control" id="status_boss">
                                                    {% for item in orstatus %}
                                                        {% if item.department_id == 6 %}
                                                            <option value="{{ item.id }}"
                                                                    {% if fr.status_boss == item.id %}
                                                                        selected
                                                                    {% endif %}
                                                            >{{ item.status_name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            {% else %}

                                                {% for item in orstatus %}
                                                    {% if item.department_id == 6 %}
                                                        {% if fr.status_boss == item.id %}
                                                            {{ item.status_name | raw }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                        {% if (role == 1 or role == 6 ) %}
                                            <div class="form-group">
                                                <label for="quote_type">Тип квоты:</label>
                                                <select class="form-control" id="quote_type">
                                                    <option value="standart"
                                                            {% if (fr.quote_type == 'standart') %}selected{% endif %}>
                                                        Английский
                                                    </option>
                                                    <option value="russian"
                                                            {% if (fr.quote_type == 'russian') %}selected{% endif %}>
                                                        Русский
                                                    </option>
                                                    <option value="russian_mod"
                                                            {% if (fr.quote_type == 'russian_mod') %}selected{% endif %}>
                                                        Русский (мод)
                                                    </option>

                                                    <option value="ape"
                                                            {% if (fr.quote_type == 'ape') %}selected{% endif %}>Приматы
                                                    </option>
                                                </select>
                                            </div>
                                        {% endif %}

                                        {% if (role == 1 or role == 6 or role == 2 ) %}
                                            <div class="form-group">
                                                <label for="margin">Маржинальность:</label>
                                                <input class="form-control" id="margin" value="{{ fr.margin }}">
                                            </div>
                                        {% endif %}


                                        <div class="form-group">
                                            <label for="status_boss">Diseases</label>
                                            {% if role in [1, 6, 7] %}
                                                <div class="row">
                                                    <div class="col-9">
                                                        <input list="disease_select" class="form-control"
                                                               id="disease_input">
                                                        <datalist id="disease_select">
                                                            {% for disease in diseases %}
                                                                <option value="{{ disease.disease_name }} : {{ disease.id }}"
                                                                        id="{{ disease.id }}"> {{ disease.disease_name_russian_old }}</option>
                                                            {% endfor %}
                                                        </datalist>
                                                    </div>
                                                    <div class="col-3">
                                                        <button class="btn btn-block btn-success" type="button"
                                                                id="disease_add"

                                                                {% if role != '1'  and role != '6' %}
                                                            style="display: none;"
                                                                {% endif %}>
                                                            <i class="fa fa-plus"></i>
                                                            ADD
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            <div id="diseases_list">
                                                {% for order_disease in order_diseases %}
                                                    {% if order_disease['disease'] != '' %}
                                                        <div id="disease_biospecimen_types_{{ order_disease['disease_id'] }}"
                                                             class="disease_block">
                                                            <div class="row">
                                                                <div class="col-9">
                                                                    <button class="btn btn-block btn-info">{{ order_disease['disease'] }}
                                                                        <br>
                                                                        <span style="font-size:10px;">{{ order_disease['mutation'] }}</span>
                                                                    </button>
                                                                </div>
                                                                <div class="col-3">
                                                                    <button class="btn btn-block btn-danger delete_disease"
                                                                            id="deldisease_{{ order_disease['disease_id'] }}"
                                                                            dbid="{{ order_disease['id'] }}"
                                                                            {% if role != '1'  and role != '6' %}
                                                                                style="display: none;"
                                                                            {% endif %}
                                                                    >X
                                                                    </button>
                                                                </div>
                                                                <div class="col-2"></div>
                                                                <div class="col-7">
                                                                    <input list="biospecimen_types_select_{{ order_disease['disease_id'] }}"
                                                                           class="form-control"
                                                                           id="biospecimen_types_input_{{ order_disease['disease_id'] }}"
                                                                            {% if role != '1'  and role != '6' %}
                                                                        style="display: none;"
                                                                            {% endif %}>
                                                                    <datalist
                                                                            id="biospecimen_types_select_{{ order_disease['disease_id'] }}"></datalist>
                                                                </div>
                                                                <div class="col-3">
                                                                    <button class="btn btn-block btn-success biospecimen_types_add"
                                                                            type="button"
                                                                            id="biospecimen_types_add_{{ order_disease['disease_id'] }}"
                                                                            {% if role != '1'  and role != '6' %}
                                                                                style="display: none;"
                                                                            {% endif %}
                                                                    >
                                                                        <i class="fa fa-plus"></i>
                                                                        ADD
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            {% if role in [1, 6] %}
                                                <div class="row">
                                                    <div class="col-2">
                                                        <input type="checkbox" {{ fr.history_quotes_search == 1 ? 'checked' : '' }}
                                                               id="history_quotes_search" class="form-control">
                                                    </div>
                                                    <div class="col-10">
                                                        <label for="history_quotes_search">Участвовать в поиске</label>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if role == '2' %}
                                        <button class="btn btn-default btn-success b10" type="button"
                                                id="form-button-save_view">
                                            <i class="fa fa-check"></i>
                                            Update changes
                                        </button>
                                    {% elseif role == '3' or role == '8' %}

                                    {% elseif role == '7' %}
                                        <button class="btn btn-default btn-success b10" type="button"
                                                id="form-button-save_commentar">
                                            <i class="fa fa-check"></i>
                                            Update changes
                                        </button>
                                    {% else %}
                                        <button class="btn btn-default btn-success b10" type="button"
                                                id="form-button-save">
                                            <i class="fa fa-check"></i>
                                            Update changes
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        {% if role != '3' and role != '7' and role != '8' %}
            <div class="accordion" id="accordionExample14">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading14">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapse14" aria-expanded="false" aria-controls="collapse14">
                                <h4 class="card-title"><h2>Подтверждение</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapse14" class="collapse" aria-labelledby="heading14"
                         data-parent="#accordionExample14" style="">
                        <div class="card-body pt-0" id="my_tickets"></div>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if role == '1' or role == '6' %}
            <div class="accordion" id="accordionExample2">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading2">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                                <h4 class="card-title"><h2>Создать задачу менеджерам</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapse2" class="collapse" aria-labelledby="heading2" data-parent="#accordionExample2">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel2">Заявка</h4>
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="new_title">Тема</label>
                                        <input id="new_title" type="text" class="form-control">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="new_manager">Менеджеры</label>
                                    <select id='new_manager' multiple='multiple'></select>
                                </div>
                                <div class="col-12">
                                    <br>
                                    <label for="new_deadline">Срок</label>
                                    <input id="new_deadline" type="date" class="form-control">
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="new_message">Сообщение</label>
                                        <textarea id="new_message" class="form-control"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn grey btn-outline-secondary"
                                    data-dismiss="modal">Отмена
                            </button>
                            <button type="button" class="btn btn-outline-primary"
                                    id="save_ticket">
                                Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if role == '1' or role == '6' %}
            <div class="accordion" id="accordionExample1">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading1">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                                <h4 class="card-title"><h2>Задачи менеджерам</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapse1" class="collapse" aria-labelledby="heading1" data-parent="#accordionExample1">
                        <div class="card-body pt-0" id="manager_tickets"></div>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- CHAT MODAL -->
        <div class="modal fade text-left" id="chat_modal" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel2"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <input type="hidden" id="contact_id">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel2">Заявка № <span
                                    id="chat_modal_header_ticket_id"></span></h4>
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12" id="chat_history"></div>
                        </div>
                        <hr>
                        {# <div class="row"> #}
                        {# <div class="col-12"> #}
                        {# <div class="form-group"> #}
                        {# <label for="new_chat_message">Сообщение</label> #}
                        {# <textarea id="new_chat_message" class="form-control"></textarea> #}
                        {# </div> #}
                        {# </div> #}
                        {# </div> #}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" style="display: none;"
                                data-dismiss="modal" id="close_ticket">Закрыть
                        </button>
                        {# <button type="button" class="btn grey btn-outline-secondary" #}
                        {# data-dismiss="modal">Отмена #}
                        {# </button> #}
                        {# <button type="button" class="btn btn-outline-primary" #}
                        {# id="send_message"> #}
                        {# Отправить #}
                        {# </button> #}
                    </div>
                </div>
            </div>
        </div>
        <!-- /CHAT MODAL -->
        {# {% endif %} #}
        <!-- MANAGER TICKET RESPONSES MODAL -->
        <div class="modal fade" id="manager_responses_modal" tabindex="-1" role="dialog"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th>Менеджер</th>
                                        <th>Ответ</th>
                                        <th>Чат</th>
                                        <th>Баллы</th>
                                        <th>Закрыть</th>
                                    </tr>
                                    </thead>
                                    <tbody id="manager_responses_table"></tbody>
                                </table>
                                {# <button type="button" class="btn btn-danger" id="close_manager_tickets"> #}
                                {# Закрыть</button> #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /MANAGER TICKET RESPONSES MODAL -->
        {% if role != '3' and role != '7' and role != '8' %}
            <div class="accordion" id="accordionExample15">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading15">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapse15" aria-expanded="false" aria-controls="collapse15">
                                <h4 class="card-title"><h2>Задачи</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapse15" class="collapse" aria-labelledby="heading15"
                         data-parent="#accordionExample15"
                         style="">
                        <div class="card-body pt-0">
                            {% if role == 6 or role == 1 %}
                                <input id="openTaskModal" type="button" class="btn btn-success" value="Новая задача">
                            {% endif %}
                            <table class="table table-bordered">
                                {% for task in tasks %}
                                    {% if task.offer_id == proj_id %}
                                        <tr id="triger_{{ task.task_id }}">
                                            <td>{{ task.task_date }}</td>
                                            <td>
                                                <a href="../orders/info/?idFR={{ task.offer_id }}">{{ task.internal_id }}</a>
                                            </td>
                                            <td>{{ task.company_name }}</td>
                                            <td>{{ task.comment }}</td>
                                            <td>{{ task.status_name }}</td>
                                            <td>{{ task.task_done_date ? 'Выполнено' : 'Не выполнено' }}</td>
                                            {% if user_id == 1 or user_id == 2 %}
                                                <td>
                                                    <button class="btn btn-danger"
                                                            onclick="delete_triger('{{ task.task_id }}')">Удалить
                                                    </button>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if role == '1' or role == '6' or user_id == '23' or user_id == '25' %}
            <div class="accordion" id="accordionExample18">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading18">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapse18" aria-expanded="false" aria-controls="collapse18">
                                <h4 class="card-title"><h2>Исторические квоты</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapse18" class="collapse" aria-labelledby="heading18"
                         data-parent="#accordionExample18">
                        <div class="card-body pt-0">
                            <br><br>
                            <div class="row">
                                <div class="col-md-2 col-sm-12">
                                    <label for="disease_filter">Disease</label>
                                    <select id="disease_filter" class="form-control">
                                        {% for disease in order_diseases %}#}
                                            <option value="{{ disease.disease_id }}">
                                                {{ disease.disease }} ({{ disease.mutation }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 col-sm-12">
                                    <label for="biospecimen_type_filter">Biospecimen type</label>
                                    <select class="form-control" id="biospecimen_type_filter">
                                        {% for item in diseases_biospecimen_types %}
                                            <option value="{{ item.biospecimen_type_id }}">
                                                {{ item.biospecimen_type }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <br><br>
                            <div style="overflow-y: auto;">
                                <table class="table table-striped table-bordered file-export dataTable" id="HQTable">
                                    <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Сайт</th>
                                        <th>Кол-во в месяц</th>
                                        <th>Срок в днях</th>
                                        <th>Оплата сайту</th>
                                        <th>Оплаты доктору</th>
                                        <th>Комментарий</th>
                                        <th>Болезнь</th>
                                        <th>Образец</th>
                                        <th></th>
                                        <th>Менеджер</th>
                                        <th style="display: none;">disease_id</th>
                                        <th style="display: none;">biospecimen_type_id</th>
                                    </tr>
                                    </thead>
                                    <tbody>

                                    {% for quote in history_quotes %}
                                        {% if (user_id == '23' and quote.department_id == '8') or ( quote.user_id =='23' and user_id == '23') %}

                                            <tr>
                                                <td>{{ quote.created_at }}</td>
                                                <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                <td>{{ quote.value_mount }}</td>
                                                <td>{{ quote.days }}</td>
                                                <td>{{ quote.price }}</td>
                                                <td>
                                                    <table>
                                                        {% for doc_payment in quote.doctor_payments %}
                                                            <tr>
                                                                <td>{{ doc_payment.doc_name }}</td>
                                                                <td>{{ doc_payment.doc_payment }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>{{ quote.comment | raw }}</td>
                                                <td>{{ quote.disease }}</td>
                                                <td>
                                                    <table>
                                                        {% for bio_type in quote.samples_table %}
                                                            <tr>
                                                                <td>{{ bio_type.biospecimen_type }}
                                                                    <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>
                                                    <button class="btn btn-info btn-block quote_info"
                                                            id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                      aria-hidden="true"></i></button>
                                                </td>
                                                <td>{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                <td style="display: none;">{{ quote.disease_id }}</td>
                                                <td style="display: none;">{{ quote.biospecimen_type_id }}</td>
                                            </tr>

                                        {% elseif (user_id == '25' and quote.department_id == '9') or ( quote.user_id =='25' and user_id == '25') %}
                                            <tr>
                                                <td>{{ quote.created_at }}</td>
                                                <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                <td>{{ quote.value_mount }}</td>
                                                <td>{{ quote.days }}</td>
                                                <td>{{ quote.price }}</td>
                                                <td>
                                                    <table>
                                                        {% for doc_payment in quote.doctor_payments %}
                                                            <tr>
                                                                <td>{{ doc_payment.doc_name }}</td>
                                                                <td>{{ doc_payment.doc_payment }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>{{ quote.comment | raw }}</td>
                                                <td>{{ quote.disease }}</td>
                                                <td>
                                                    <table>
                                                        {% for bio_type in quote.samples_table %}
                                                            <tr>
                                                                <td>{{ bio_type.biospecimen_type }}
                                                                    <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>
                                                    <button class="btn btn-info btn-block quote_info"
                                                            id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                      aria-hidden="true"></i></button>
                                                </td>
                                                <td>{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                <td style="display: none;">{{ quote.disease_id }}</td>
                                                <td style="display: none;">{{ quote.biospecimen_type_id }}</td>
                                            </tr>
                                        {% elseif role == '1' or role == '6' %}
                                            <tr>
                                                <td>{{ quote.created_at }}</td>
                                                <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                <td>{{ quote.value_mount }}</td>
                                                <td>{{ quote.days }}</td>
                                                <td>{{ quote.price }}</td>
                                                <td>
                                                    <table>
                                                        {% for doc_payment in quote.doctor_payments %}
                                                            <tr>
                                                                <td>{{ doc_payment.doc_name }}</td>
                                                                <td>{{ doc_payment.doc_payment }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>{{ quote.comment | raw }}</td>
                                                <td>{{ quote.disease }}</td>
                                                <td>
                                                    <table>
                                                        {% for bio_type in quote.samples_table %}
                                                            <tr>
                                                                <td>{{ bio_type.biospecimen_type }}
                                                                    <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </td>
                                                <td>
                                                    <button class="btn btn-info btn-block quote_info"
                                                            id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                      aria-hidden="true"></i></button>
                                                </td>
                                                <td>{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                <td style="display: none;">{{ quote.disease_id }}</td>
                                                <td style="display: none;">{{ quote.biospecimen_type_id }}</td>
                                            </tr>
                                        {% endif %}





                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if role == '1' or role == '6' or user_id == '23' or user_id == '25' or role == '2' %}
            <section>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title"><h2>Квоты менеджеров</h2></h4>
                                <div style="margin-top: 10px;">
                                <button class="btn btn-info"  onclick="hideColumn('data_1', this)" style="padding: 5px;"> Дата </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_2', this)" style="padding: 5px;"> Сайт </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_3', this)" style="padding: 5px;"> Кол-во в месяц </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_4', this)" style="padding: 5px;"> Срок в днях </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_5', this)" style="padding: 5px;"> Оплата сайту </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_6', this)" style="padding: 5px;"> Оплаты доктору </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_7', this)" style="padding: 5px;"> Комментарий </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_8', this)" style="padding: 5px;"> Болезнь </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_9', this)" style="padding: 5px;"> Образец </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_10', this)" style="padding: 5px;"> i </button>
                                <button class="btn btn-info"  onclick="hideColumn('data_11', this)" style="padding: 5px;"> Менеджер </button>
                                </div>
                                <div class="row" style="width: 100%; margin-bottom: 15px;">
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <select class="form-control" id="man_quote_manager_select">
                                            <option value="0">Выберите менеджера</option>
                                            {% set manArray = [] %}
                                            {% for quote in quotes %}
                                                {% if quote.user_id not in manArray %}
                                                    <option value="{{ quote.user_id }}">{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</option>
                                                    {% set manArray = manArray|merge([quote.user_id]) %}
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <select class="form-control" id="man_quote_disease_select">
                                            <option value="0">Выберите Болезнь</option>
                                            {% set diseaseArray = [] %}
                                            {% for quote in quotes %}
                                                {% if quote.disease not in diseaseArray %}
                                                    <option value="{{ quote.disease }}">{{ quote.disease }}</option>
                                                    {% set diseaseArray = diseaseArray|merge([quote.disease]) %}
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-content ">
                                <div class="card-body card-dashboard " style="overflow-y: auto;">
                                    <table class="table table-bordered file-export dataTable" id="man_quote_table">
                                        <thead>
                                        <tr>
                                            <th class="data_1">Дата</th>
                                            <th class="data_2">Сайт</th>
                                            <th class="data_3">Кол-во в месяц</th>
                                            <th class="data_4">Срок в днях</th>
                                            <th class="data_5">Оплата сайту</th>
                                            <th class="data_6">Оплаты доктору</th>
                                            <th class="data_7">Комментарий</th>
                                            <th class="data_8">Болезнь</th>
                                            <th class="data_9">Образец</th>
                                            <th class="data_10">i</th>
                                            <th class="data_11">Менеджер</th>
                                        </tr>
                                        </thead>
                                        <tbody>


                                        {% for quote in quotes %}
                                            {% if (user_id == '23' and quote.department_id == '8') or ( quote.user_id =='23' and user_id == '23') %}
                                                <tr manager="{{ quote.user_id }}" disease="{{ quote.disease }}">
                                                    {# <td>{{ quote.department_id }}</td> #}
                                                    <td class="data_1">{{ quote.created_at }}</td>
                                                    <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                    <td class="data_3">{{ quote.value_mount }}</td>
                                                    <td class="data_4">{{ quote.days }}</td>
                                                    <td class="data_5">{{ quote.price }}</td>
                                                    <td class="data_6">
                                                        <table class="table-striped">
                                                            {% for doc_payment in quote.doctor_payments %}
                                                                <tr>
                                                                    <td>{{ doc_payment.doc_name }}</td>
                                                                    <td>{{ doc_payment.doc_payment }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_7">{{ quote.comment | raw }}</td>
                                                    <td class="data_8">{{ quote.disease }}</td>
                                                    <td class="data_9">
                                                        <table class="table-striped">
                                                            {% for bio_type in quote.samples_table %}
                                                                <tr>
                                                                    <td>{{ bio_type.biospecimen_type }}
                                                                        <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_10">
                                                        <button class="btn btn-info btn-block quote_info"
                                                                id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                          aria-hidden="true"></i>
                                                        </button>
                                                    </td>
                                                    <td class="data_11">{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                </tr>
                                            {% elseif (user_id == '25' and quote.department_id == '9') or ( quote.user_id =='25' and user_id == '25') %}
                                                <tr manager="{{ quote.user_id }}" disease="{{ quote.disease }}">
                                                    {# <td>{{ quote.department_id }}</td> #}
                                                    <td class="data_1">{{ quote.created_at }}</td>
                                                    <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                    <td class="data_3">{{ quote.value_mount }}</td>
                                                    <td class="data_4">{{ quote.days }}</td>
                                                    <td class="data_5">{{ quote.price }}</td>
                                                    <td class="data_6">
                                                        <table class="table-striped">
                                                            {% for doc_payment in quote.doctor_payments %}
                                                                <tr>
                                                                    <td>{{ doc_payment.doc_name }}</td>
                                                                    <td>{{ doc_payment.doc_payment }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_7">{{ quote.comment | raw }}</td>
                                                    <td class="data_8">{{ quote.disease }}</td>
                                                    <td class="data_9">
                                                        <table class="table-striped">
                                                            {% for bio_type in quote.samples_table %}
                                                                <tr>
                                                                    <td>{{ bio_type.biospecimen_type }}
                                                                        <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_10">
                                                        <button class="btn btn-info btn-block quote_info"
                                                                id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                          aria-hidden="true"></i>
                                                        </button>
                                                    </td>
                                                    <td class="data_11">{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                </tr>
                                            {% elseif role == '1' or role == '6' or role == '2' %}
                                                <tr manager="{{ quote.user_id }}" disease="{{ quote.disease }}">
                                                    {# <td>{{ quote.department_id }}</td> #}
                                                    <td class="data_1">{{ quote.created_at }}</td>
                                                    <td>{{ quote.site_id-1 }} {{ quote.site_name }}</td>
                                                    <td class="data_3">{{ quote.value_mount }}</td>
                                                    <td class="data_4">{{ quote.days }}</td>
                                                    <td class="data_5">{{ quote.price }}</td>
                                                    <td class="data_6">
                                                        <table class="table-striped">
                                                            {% for doc_payment in quote.doctor_payments %}
                                                                <tr>
                                                                    <td>{{ doc_payment.doc_name }}</td>
                                                                    <td>{{ doc_payment.doc_payment }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_7">{{ quote.comment | raw }}</td>
                                                    <td class="data_8">{{ quote.disease }}</td>
                                                    <td class="data_9">
                                                        <table class="table-striped">
                                                            {% for bio_type in quote.samples_table %}
                                                                <tr>
                                                                    <td>{{ bio_type.biospecimen_type }}
                                                                        <b>{{ bio_type.biospecimen_type_russian }}</b> {{ bio_type.mod }}
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </table>
                                                    </td>
                                                    <td class="data_10">
                                                        <button class="btn btn-info btn-block quote_info"
                                                                id="qi_{{ quote.id }}"><i class="fa fa-info"
                                                                                          aria-hidden="true"></i>
                                                        </button>
                                                    </td>
                                                    <td class="data_11">{{ quote.lasttname }} {{ quote.firstname }} {{ quote.patronymic }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </section>
        {% endif %}

        {% if (inventory.id > 0) %}
            {% if (role == '3' and department_id == '3') or (role != '3' and role != '8') and department_id != '4' %}
                <div class="accordion" id="accordionExample11">
                    <div class="card collapse-icon accordion-icon-rotate">
                        <div class="accordion-header card-header" id="heading11">
                            <h2 class="mb-0">
                                <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                                   data-target="#collapse11" aria-expanded="false" aria-controls="collapse11">
                                    <h4 class="card-title"><h2>Инвентори</h2></h4>
                                </a>
                            </h2>
                        </div>
                        <div id="collapse11" class="collapse" aria-labelledby="heading11"
                             data-parent="#accordionExample11"
                             style="">
                            <div class="card-body pt-0">
                                <div class="row">
                                    <div class="col-md-6 col-sm-12">


                                        {% if role == '6'  or department_id == '3' %}
                                            <div class="col-md-12 col-sm-12">
                                                <label for="inventory_sample">Есть ли образец</label>
                                                <select class="form-control" id="inventory_sample" class="form-control">
                                                    <option value="0"
                                                            {% if inventory.sample == 0 %}
                                                                selected
                                                            {% endif %}
                                                    >Есть ли образец
                                                    </option>
                                                    <option value="1"
                                                            {% if inventory.sample == 1 %}
                                                                selected
                                                            {% endif %}
                                                    >Да
                                                    </option>
                                                    <option value="2"
                                                            {% if inventory.sample == 2 %}
                                                                selected
                                                            {% endif %}
                                                    >Нет
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-12 col-sm-12 mt-2">
                                                <label for="inventory_alias">Ссылка</label>
                                                <input type="text" value="{{ inventory.alias }}"
                                                       id="inventory_alias" class="form-control">
                                            </div>

                                            <div class="col-md-12 col-sm-12 mt-2">
                                                <label for="inventory_comments">Комментарий</label>
                                                <textarea name="inventory_comments" id="inventory_comments" cols="30"
                                                          rows="10">{{ inventory.comments }}</textarea>
                                                <input type="hidden" id="inventory_id" value="{{ inventory.id }}">
                                            </div>


                                            <div class="col-md-12 col-sm-12">
                                                {{ inventory.lasttname }}
                                                {{ inventory.firstname }}
                                                {{ inventory.created_at }}
                                            </div>
                                            <div class="col-md-12 col-sm-12 mt-4">
                                                <button class="btn btn-dark" id="inventory_save">Сохранить</button>
                                            </div>
                                        {% else %}

                                            <div class="col-md-12 col-sm-12">
                                                <table class="table table-bordered">
                                                    <tr>
                                                        <td>Если ли инвентори</td>
                                                        <td><b> {% if inventory.sample == 2 %} Нет {% endif %}
                                                                {% if inventory.sample == 1 %} Да {% endif %}
                                                                {% if inventory.sample == 0 %} Инветори не отработан {% endif %}</b>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Ссылка</td>
                                                        <td><b>{{ inventory.alias }}</b></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Комментарий</td>
                                                        <td>{{ inventory.comments | raw }}</td>
                                                    </tr>

                                                    <tr>
                                                        <td>  {{ inventory.lasttname }}   {{ inventory.firstname }}</td>
                                                        <td>  {{ inventory.created_at }} </td>
                                                    </tr>
                                                </table>
                                            </div>


                                        {% endif %}
                                    </div>
                                </div>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        {% if (laboratory.id > 0) %}
        {% if (department_id == '4') or (role != '3' and role != '7'  and role != '8') %}
        <div class="accordion" id="accordionExample12">
            <div class="card collapse-icon accordion-icon-rotate">
                <div class="accordion-header card-header" id="heading12">
                    <h2 class="mb-0">
                        <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                           data-target="#collapse12" aria-expanded="false" aria-controls="collapse12">
                            <h4 class="card-title"><h2>ЛТО</h2></h4>
                        </a>
                    </h2>
                </div>
                <div id="collapse12" class="collapse" aria-labelledby="heading12"
                     data-parent="#accordionExample12"
                     style="">
                    <div class="card-body pt-0">
                        <div class="row">
                            <div class="col-md-12 col-sm-12">

                                {% if role == '6'  or department_id == '4' %}
                                <div class="row">
                                    <div class="col-md-6 col-sm-12">
                                        <label for="laboratory_sample">Требуется процессинг/исследования по
                                            данному
                                            образцу выполнимы ДА/НЕТ</label>
                                        <select class="form-control" id="laboratory_sample"
                                                class="form-control">
                                            <option value="0"
                                                    {% if laboratory.sample == 0 %}
                                                        selected
                                                    {% endif %}
                                            >Требуется процессинг/исследования
                                            </option>
                                            <option value="1"
                                                    {% if laboratory.sample == 1 %}
                                                        selected
                                                    {% endif %}
                                            >Да
                                            </option>
                                            <option value="2"
                                                    {% if laboratory.sample == 2 %}
                                                        selected
                                                    {% endif %}
                                            >Нет
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="material_intake">Потребуют дополнительный забора образца
                                            ДА/НЕТ</label>
                                        <select class="form-control" id="material_intake" class="form-control">
                                            <option value="0"
                                                    {% if laboratory.material_intake == 0 %}
                                                        selected
                                                    {% endif %}
                                            >Потребуют дополнительный забора образца
                                            </option>
                                            <option value="1"
                                                    {% if laboratory.material_intake == 1 %}
                                                        selected
                                                    {% endif %}
                                            >Да
                                            </option>
                                            <option value="2"
                                                    {% if laboratory.material_intake == 2 %}
                                                        selected
                                                    {% endif %}
                                            >Нет
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="material_intake_text">Какого</label>
                                        <input type="text" value="{{ laboratory.material_intake_text }}"
                                               id="material_intake_text" class="form-control">
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="material_intake_num">Сколько</label>
                                        <input type="number" value="{{ laboratory.material_intake_num }}"
                                               id="material_intake_num" class="form-control">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="expendable_materials">Потребуют дополнительных расходных
                                            материалов ДА/НЕТ</label>
                                        <select class="form-control" id="expendable_materials"
                                                class="form-control">
                                            <option value="0"
                                                    {% if laboratory.expendable_materials == 0 %}
                                                        selected
                                                    {% endif %}
                                            >Потребуют дополнительных расходных материалов
                                            </option>
                                            <option value="1"
                                                    {% if laboratory.expendable_materials == 1 %}
                                                        selected
                                                    {% endif %}
                                            >Да
                                            </option>
                                            <option value="2"
                                                    {% if laboratory.expendable_materials == 2 %}
                                                        selected
                                                    {% endif %}
                                            >Нет
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="expendable_materials_text">Каких</label>
                                        <input type="text" value="{{ laboratory.expendable_materials_text }}"
                                               id="expendable_materials_text" class="form-control">
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="expendable_materials_num">Стоимость полного
                                            комплекта</label>
                                        <input type="number" value="{{ laboratory.expendable_materials_num }}"
                                               id="expendable_materials_num" class="form-control">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="financial_expenses">Потребуются дополнительные финансовые
                                            расходы</label>
                                        <select class="form-control" id="financial_expenses"
                                                class="form-control">
                                            <option value="0"
                                                    {% if laboratory.financial_expenses == 0 %}
                                                        selected
                                                    {% endif %}
                                            >Потребуются дополнительные финансовые расходы
                                            </option>
                                            <option value="1"
                                                    {% if laboratory.financial_expenses == 1 %}
                                                        selected
                                                    {% endif %}
                                            >Да
                                            </option>
                                            <option value="2"
                                                    {% if laboratory.financial_expenses == 2 %}
                                                        selected
                                                    {% endif %}
                                            >Нет
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="financial_expenses_text">На что ?</label>
                                        <input type="text" value="{{ laboratory.financial_expenses_text }}"
                                               id="financial_expenses_text" class="form-control">
                                    </div>
                                    <div class="col-md-4 col-sm-12 mt-2">
                                        <label for="financial_expenses_num">Сумма</label>
                                        <input type="number" value="{{ laboratory.financial_expenses_num }}"
                                               id="financial_expenses_num" class="form-control">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 col-sm-12 mt-2">
                                        <label for="lavaratory_comments">Комментарий</label>
                                        <textarea name="laboratory_comments" id="laboratory_comments" cols="30"
                                                  rows="10">{{ laboratory.comments }}</textarea>
                                        <input type="hidden" id="laboratory_id" value="{{ laboratory.id }}">
                                    </div>
                                </div>


                                <div class="row">
                                    <div class="col-md-12 col-sm-12">
                                        {{ laboratory.lasttname }}
                                        {{ laboratory.firstname }}:
                                        {{ laboratory.created_at }}
                                    </div>
                                    <div class="col-md-12 col-sm-12 mt-4">
                                        <button class="btn btn-dark" id="lavaratory_save">Сохранить</button>
                                    </div>

                                </div>
                                {% else %}

                                <div class="row">
                                    <div class="col-12">
                                        <table class="table table-bordered">
                                            <tr>
                                                <td colspan="4">Требуется процессинг/исследования по данному
                                                    образцу выполнимы:
                                                </td>
                                                <td colspan="2">
                                                    <b>{% if laboratory.sample == 2 %} Нет {% endif %}
                                                        {% if laboratory.sample == 1 %} Да {% endif %}
                                                        {% if laboratory.sample == 0 %} ЛТО не отработан {% endif %}</b>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td>Потребуют дополнительный забора образца:</td>
                                                <td>
                                                    <b>  {% if laboratory.material_intake == 2 %} Нет {% endif %}
                                                        {% if laboratory.material_intake == 1 %} Да {% endif %}
                                                        {% if laboratory.material_intake == 0 %} Не выбрано {% endif %}</b>
                                                </td>
                                                <td>Какого:</td>
                                                <td><b>{{ laboratory.material_intake_text }}</b></td>
                                                <td>Сколько</td>
                                                <td><b>{{ laboratory.material_intake_num }} </b></td>
                                            </tr>

                                            <tr>
                                                <td>Потребуют дополнительных расходных материалов</td>
                                                <td>
                                                    <b>  {% if laboratory.expendable_materials == 2 %} Нет {% endif %}
                                                        {% if laboratory.expendable_materials == 1 %} Да {% endif %}
                                                        {% if laboratory.expendable_materials == 0 %} Не выбрано {% endif %}</b>
                                                </td>
                                                <td>Каких:</td>
                                                <td><b>{{ laboratory.expendable_materials_text }}</b></td>
                                                <td>Стоиомсть полного комплекта</td>
                                                <td><b>{{ laboratory.expendable_materials_num }} </b></td>
                                            </tr>


                                            <tr>
                                                <td>Потребуются дополнительные финансовые расходы</td>
                                                <td>
                                                    <b>  {% if laboratory.financial_expenses == 2 %} Нет {% endif %}
                                                        {% if laboratory.financial_expenses == 1 %} Да {% endif %}
                                                        {% if laboratory.financial_expenses == 0 %} Не выбрано {% endif %}</b>
                                                </td>
                                                <td>На что:</td>
                                                <td><b>{{ laboratory.financial_expenses_text }}</b></td>
                                                <td>Сумма</td>
                                                <td><b>{{ laboratory.financial_expenses_num }} </b></td>
                                            </tr>
                                            <tr>
                                                <td>Комментарий</td>
                                                <td colspan="5">{{ laboratory.comments | raw }}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="3">{{ laboratory.lasttname }}  {{ laboratory.firstname }}
                                                    :
                                                </td>
                                                <td colspan="3">{{ laboratory.created_at }}:</td>
                                            </tr>

                                        </table>
                                    </div>

                                    {% endif %}
                                </div>
                            </div>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}
            {% endif %}
            {% if (fr.quote_type == 'standart') %}
                {% if role == '1' or role == '6' or role == '2' %}
                    <div class="accordion" id="accordionExample13">
                        <div class="card collapse-icon accordion-icon-rotate">
                            <div class="accordion-header card-header" id="heading13">
                                <h2 class="mb-0">
                                    <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed"
                                       data-toggle="collapse"
                                       data-target="#collapse13" aria-expanded="false" aria-controls="collapse13">
                                        <h4 class="card-title"><h2>Проект квоты</h2></h4>
                                    </a>
                                </h2>
                            </div>
                            <div id="collapse13" class="collapse" aria-labelledby="heading13"
                                 data-parent="#accordionExample13"
                                 style="">
                                <div class="card-body pt-0">
                                    <offer
                                            :proj_id="{{ fr.proj_id }}"
                                            :script_id="{{ script_id }}"
                                            :currency="'{{ currency }}'"
                                            :order_diseases="{{ order_disease_options }}"
                                            :order_samples="{{ order_diseases_biospecimen }}"
                                            :offer="{{ offer }}"
                                            :offer_items="{{ offer_items }}"
                                    ></offer>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            {% if (fr.quote_type == 'russian') %}
                {% if role == '1' or role == '6' or role == '2' %}
                    <div class="accordion" id="accordionExample17">
                        <div class="card collapse-icon accordion-icon-rotate">
                            <div class="accordion-header card-header" id="heading17">
                                <h2 class="mb-0">
                                    <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed"
                                       data-toggle="collapse"
                                       data-target="#collapse17" aria-expanded="false" aria-controls="collapse17">
                                        <h4 class="card-title"><h2>Проект квоты на русском языке</h2></h4>
                                    </a>
                                </h2>
                            </div>
                            <div id="collapse17" class="collapse" aria-labelledby="heading17"
                                 data-parent="#accordionExample17"
                                 style="">
                                <div class="card-body pt-0">
                                    <offer_ru
                                            :proj_id="{{ fr.proj_id }}"
                                            :script_id="{{ script_id }}"
                                            :currency="'{{ currency }}'"
                                            :order_diseases="{{ order_disease_options }}"
                                            :order_samples="{{ order_diseases_biospecimen_rus }}"
                                            :offer_ru="{{ offer_ru }}"
                                            :offer_ru_items="{{ offer_ru_items }}"
                                    ></offer_ru>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            {% if (fr.quote_type == 'russian_mod') %}
                {% if role == '1' or role == '6' or role == '2' %}
                    <div class="accordion" id="accordionExample17">
                        <div class="card collapse-icon accordion-icon-rotate">
                            <div class="accordion-header card-header" id="heading17">
                                <h2 class="mb-0">
                                    <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed"
                                       data-toggle="collapse"
                                       data-target="#collapse17" aria-expanded="false" aria-controls="collapse17">
                                        <h4 class="card-title"><h2>Проект квоты на русском языке (мод)</h2></h4>
                                    </a>
                                </h2>
                            </div>
                            <div id="collapse17" class="collapse" aria-labelledby="heading17"
                                 data-parent="#accordionExample17"
                                 style="">
                                <div class="card-body pt-0">
                                    <offer_ru_mod
                                            :proj_id="{{ fr.proj_id }}"
                                            :script_id="{{ script_id }}"
                                            :currency="'{{ currency }}'"
                                            :order_diseases="{{ order_disease_options }}"
                                            :order_samples="{{ order_diseases_biospecimen_rus }}"
                                            :offer_ru="{{ offer_ru }}"
                                            :offer_ru_items="{{ offer_ru_items }}"
                                    ></offer_ru_mod>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}


            {% if (fr.quote_type == 'ape') %}
                {% if role == '1' or role == '6' or role == '2' %}
                    <div class="accordion" id="accordionExample16">
                        <div class="card collapse-icon accordion-icon-rotate">
                            <div class="accordion-header card-header" id="heading16">
                                <h2 class="mb-0">
                                    <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed"
                                       data-toggle="collapse"
                                       data-target="#collapse16" aria-expanded="false" aria-controls="collapse16">
                                        <h4 class="card-title"><h2>ШАБЛОН ПРИМАТЫ</h2></h4>
                                    </a>
                                </h2>
                            </div>
                            <div id="collapse16" class="collapse" aria-labelledby="heading16"
                                 data-parent="#accordionExample16"
                                 style="">
                                <div class="card-body pt-0">
                                    <ape_offer
                                            :proj_id="{{ fr.proj_id }}"
                                            :script_id="{{ script_id }}"
                                            :currency="'{{ currency }}'"
                                    ></ape_offer>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            {% if role != '3' and role != '7'  and role != '8' %}
                <div class="accordion" id="accordionExample3">
                    <div class="card collapse-icon accordion-icon-rotate">
                        <div class="accordion-header card-header" id="heading10">
                            <h2 class="mb-0">
                                <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                                   data-target="#collapse09" aria-expanded="false" aria-controls="collapse09">
                                    <h4 class="card-title"><h2>Статистика по worksheets</h2></h4>
                                </a>
                            </h2>
                        </div>
                        <div id="collapse09" class="collapse" aria-labelledby="heading10"
                             data-parent="#accordionExample3"
                             style="">
                            <div class="card-body pt-0">
                                <section>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">
                                                </div>
                                                <div class="card-content ">
                                                    <div class="card-body card-dashboard ">
                                                        <table class="table table-striped table-bordered file-export dataTable">
                                                            <thead>
                                                            <tr>
                                                                <th>Статус</th>
                                                                <th>Комментарий</th>
                                                                <th>Менеджер</th>
                                                                <th>Действие</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            {% for worksheet in worksheets %}
                                                                <tr>
                                                                    <td> {% if worksheet.status_id == 1 %}
                                                                            Не отработан
                                                                        {% elseif worksheet.status_id == 3 %}
                                                                            Отказ
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>{{ worksheet.comments }}</td>
                                                                    <td>{{ worksheet.lasttname }} {{ worksheet.firstname }} {{ worksheet.patronymic }}
                                                                    <td>  {% if worksheet.status_id == 1 %}
                                                                        <button class="btn-dark btn"
                                                                                onclick="sendMail({{ worksheet.user_id }})">
                                                                            <i
                                                                                    class="ft-rotate-cw"></i> Resend
                                                                        </button>
                                                                    </td>
                                                                    {% endif %}</td>
                                                                </tr>
                                                            {% endfor %}

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}


            <div class="accordion" id="accordionExampleChat">
                <div class="card collapse-icon accordion-icon-rotate">
                    <div class="accordion-header card-header" id="heading10">
                        <h2 class="mb-0">
                            <a class="btn btn-link mb-0 pb-3 text-decoration-none collapsed" data-toggle="collapse"
                               data-target="#collapseChat" aria-expanded="false" aria-controls="collapseChat">
                                <h4 class="card-title"><h2>Чат с клиентом</h2></h4>
                            </a>
                        </h2>
                    </div>
                    <div id="collapseChat" class="collapse" aria-labelledby="heading10"
                         data-parent="#accordionExampleChat"
                         style="">
                        <div class="card-body pt-0">
                            <chat :proj_id="{{ fr.proj_id }}"></chat>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade text-left" id="offerTaskModal" role="dialog" aria-labelledby="myModalLabel4"
                 aria-hidden="true">
                <div id="modalview">
                    <div class="modal-dialog modal-xl" role="document" style="width: 80% !important;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title" id="myModalLabel2"><i class="fa fa-road2"></i> <b>Добавить
                                        задачу </b></h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <label for="task_text">Комментарий</label>
                                <input type="text" class="form-control" id="task_text">
                                <label for="task_trigger_status">Статус</label>
                                <select class="form-control" id="task_trigger_status"></select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn grey btn-outline-secondary" data-dismiss="modal">
                                    Close
                                </button>
                                <button type="button" class="btn  btn-success" id="saveTask">Сохранить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade text-left" id="quotes_info_modal" role="dialog" aria-hidden="true">
                <div>
                    <div class="modal-dialog modal-xl" role="document" style="width: 80% !important;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Образцы</h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" id="quote_info_rows"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
</div>

<script>

    function hideColumn(_class, button) {
        let block = document.querySelectorAll(`.${_class}`)
        if (!button.classList.contains("btn-info")) {
            button.classList.add("btn-info");
            button.classList.remove("btn-danger");
        } else {
            button.classList.add("btn-danger");
            button.classList.remove("btn-info");
        }

        block.forEach(el => {
            if (!el.classList.contains("not_visable")) {
                el.classList.add("not_visable");
            } else {
                el.classList.remove("not_visable");
            }
        })


    }


    function sendMail(user_id) {
        let proj_id = `{{ fr.proj_id }}`;

        $.ajax({
            url: '/mail/SendKick/',
            method: 'POST',
            data: {
                proj_id: proj_id,
                user_id: user_id,
            }
        })
            .done(function (text) {
                toastr.success('Письмо отправлено');
            });

    }


    function sendNewInfo() {
        let proj_id = `{{ fr.proj_id }}`;

        $.ajax({
            url: '/mail/SendNewInfo/',
            method: 'POST',
            data: {
                proj_id: proj_id
            }
        })
            .done(function (text) {
                toastr.success('Письмо отправлено');
            });

    }

    document.addEventListener('DOMContentLoaded', function () {
        // Выделяем нужны select
        if (document.getElementById('fr_status_id')) {
            document.getElementById('fr_status_id').value = Number(`{{ fr.fr_status }}`);
        }

        if (document.getElementById('fr_script_id')) {
            document.getElementById('fr_script_id').value = Number(`{{ fr.fr_script_id }}`);
        }

        if (document.getElementById('answering_id')) {
            document.getElementById('answering_id').value = Number(`{{ fr.answering_id }}`);

        }


        if (document.getElementById('status_client')) {
            $('#status_client').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_client = $('#status_client').val();

                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: {
                        "proj_id": proj_id,
                        "status_client": status_client
                    }
                })
                    .done(function (text) {
                        if (text == 1) {
                            toastr.success('Статус изменен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                            if (status_client == '27') {
                                location.reload();
                            }

                        } else {
                            toastr.error(text);
                        }

                    })
            })
        }

        // Слушатель на изменения статуса клиента


        // Слушатель на измененеия статуса менеджера

        if (document.getElementById('status_manager')) {
            $('#status_manager').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_manager = $('#status_manager').val();
                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: {
                        "proj_id": proj_id,
                        "status_manager": status_manager
                    }
                })
                    .done(function (text) {
                        if (text == 1) {
                            toastr.success('Статус изменен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                        } else {
                            toastr.error(text);
                        }
                    })
            })
        }

        //Слушатель на изменение статуса Проектный отдел

        if (document.getElementById('status_project')) {
            $('#status_project').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_project = $('#status_project').val();
                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: {
                        "proj_id": proj_id,
                        "status_project": status_project
                    }
                })
                    .done(function (text) {
                        if (text == 1) {
                            toastr.success('Статус изменен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                        } else {
                            toastr.error(text);
                        }
                    })
            })
        }


        // Слушатель на изменения статуса ЛТО

        if (document.getElementById('status_lpo')) {
            $('#status_lpo').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_lpo = $('#status_lpo').val();
                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: {
                        "proj_id": proj_id,
                        "status_lpo": status_lpo
                    }
                })
                    .done(function (text) {
                        if (text == 1) {
                            toastr.success('Статус изменен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                        } else {
                            toastr.error(text);
                        }
                    })
            })
        }

        // Слушатель на изменеия статуса ВЭД

        if (document.getElementById('status_ved')) {
            $('#status_ved').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_ved = $('#status_ved').val();
                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: {
                        "proj_id": proj_id,
                        "status_ved": status_ved
                    }
                })
                    .done(function (text) {
                        if (text == 1) {
                            toastr.success('Статус изменен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                        } else {
                            toastr.error(text);
                        }
                    })
            })
        }

        // Слушатель на изменение статуса Руководитель

        if (document.getElementById('status_boss')) {
            $('#status_boss').change(() => {
                let proj_id = `{{ fr.proj_id }}`;
                let status_boss = $('#status_boss').val();

                if (status_boss == '40' || status_boss == '44' || status_boss == '45') {
                    if ($("#margin").val() != '') {

                        $.ajax({
                            url: '/orders/save/',
                            method: 'POST',
                            data: {
                                "proj_id": proj_id,
                                "status_boss": status_boss
                            }
                        })
                            .done(function (text) {
                                if (text == 1) {
                                    toastr.success('Статус изменен');
                                    socket.emit('eventChangeStatusFRTABLE', proj_id);
                                } else {
                                    toastr.error(text);
                                }
                            })
                    } else {
                        toastr.error('Нельзя выставить данный статус', 'Заполните поле маржинальность')
                    }

                } else {
                    $.ajax({
                        url: '/orders/save/',
                        method: 'POST',
                        data: {
                            "proj_id": proj_id,
                            "status_boss": status_boss
                        }
                    })
                        .done(function (text) {
                            if (text == 1) {
                                toastr.success('Статус изменен');
                                socket.emit('eventChangeStatusFRTABLE', proj_id);
                            } else {
                                toastr.error(text);
                            }
                        })
                }


            })
        }


        // TODO Статусы сохроняются автоматом , нужно убрать из из отправик общего сохранения

        let saveOrder = () => {
            let proj_id = `{{ fr.proj_id }}`;
            let fr_date = document.getElementById('fr_date').value;
            let linked_fr_id = document.getElementById('linked_fr_id').value;
            let fr_script_id = document.getElementById('fr_script_id').value;

            let attention_to;

            if (document.getElementById('fr_attention_to')) {
                attention_to = document.getElementById('fr_attention_to').value;
            }

            let script_number = document.getElementById('script_number').value;
            let internal_id = document.getElementById('internal_id').value;
            let project_name = document.getElementById('project_name').value;
            let quote_date = document.getElementById('quote_date').value;
            let external_id = document.getElementById('external_id').value;
            // let comments = document.getElementById('comments');
            let comments = tinymce.get('comments').getContent();
            let feas_russian = tinymce.get('feas_russian').getContent();
            let unformal_quote = tinymce.get('unformal_quote').getContent();
            let history_po = '';
            if (document.getElementById('history_po')) {
                history_po = tinymce.get('history_po').getContent();
            }

            let clinical_inclusion = tinymce.get('clinical_inclusion').getContent();
            let quotes_from_managers = tinymce.get('quotes_from_managers').getContent();
            let project_details = tinymce.get('project_details').getContent();


            let fr_status_id = document.getElementById('fr_status_id').value;
            let fr_status_date = document.getElementById('fr_status_date').value;
            let currency = document.getElementById('currency').value;


            let deadline = document.getElementById('deadline').value;
            let answering_id = document.getElementById('answering_id').value;

            let deadline_quote = document.getElementById('deadline_quote').value;
            let deadline_post = document.getElementById('deadline_post').value;
            let history_quotes_search = $("#history_quotes_search").prop('checked') ? 1 : 0

            let status_manager = document.getElementById('status_manager').value;
            let status_project = document.getElementById('status_project').value;
            let status_lpo = document.getElementById('status_lpo').value;
            let status_ved = document.getElementById('status_ved').value;
            let status_boss = document.getElementById('status_boss').value;
            let status_client = document.getElementById('status_client').value;
            let quote_type = document.getElementById('quote_type').value;

            let communication_date = '';
            if (document.getElementById('communication_date')) {
                communication_date = document.getElementById('communication_date').value;
            }

            let communication_comment = '';
            if (document.getElementById('communication_comment')) {
                communication_comment = tinymce.get('communication_comment').getContent();
            }

            let priority = document.getElementById('fr_priority').value


            let lto_comment = '';
            if (document.getElementById('fr_lto_comment')) {
                lto_comment = tinymce.get('fr_lto_comment').getContent();
            }
            let po_comment = '';
            if (document.getElementById('fr_po_comment')) {
                po_comment = tinymce.get('fr_po_comment').getContent();
            }


            let data = {
                proj_id, fr_date, linked_fr_id, fr_script_id, attention_to,
                script_number, internal_id, project_name, comments, feas_russian,
                fr_status_id, fr_status_date, project_details, currency, clinical_inclusion,
                unformal_quote, history_po, quote_date, quotes_from_managers, answering_id,
                external_id, deadline, deadline_quote, deadline_post, status_manager,
                status_project, status_lpo, status_ved, status_boss, status_client,
                history_quotes_search, quote_type, communication_date, communication_comment, priority,
                lto_comment, po_comment
            }
            if (document.getElementById('historical_data'))
                data.historical_data = tinymce.get('historical_data').getContent()
            if ($("#margin").length)
                data.margin = $("#margin").val()

            if (deadline == '') {
                toastr.error('Заполните поле deadline');
            } else if (answering_id == 0) {
                toastr.error('Выберите ответственного');
            } else {
                $.ajax({
                    url: '/orders/save/',
                    method: 'POST',
                    data: data
                })
                    .done(function (text) {
                        toastr.success('Данные сохранены');

                        if (fr_status_id == 3 || fr_status_id == 5 || fr_status_id == 6) {
                            let data = {
                                'users_id': user_id
                            }
                        }
                        location.reload();
                    });
            }


        };


        let saveOrderCommenter = () => {
            let proj_id = `{{ fr.proj_id }}`;

            let comments = tinymce.get('comments').getContent();

            $.ajax({
                url: '/orders/save/',
                method: 'POST',
                data: {
                    proj_id: proj_id,
                    comments: comments,
                }
            }).done(function (text) {
                toastr.success('Данные сохранены');
                location.reload();
            });
        }


        let saveOrder_view = () => {
            let proj_id = `{{ fr.proj_id }}`;
            let fr_status_id = document.getElementById('fr_status_id').value;
            let deadline_post = document.getElementById('deadline_post').value;
            let deadline_quote = document.getElementById('deadline_quote').value;
            let deadline = document.getElementById('deadline').value;

            $.ajax({
                url: '/orders/save/',
                method: 'POST',
                data: {
                    proj_id: proj_id,
                    fr_status: fr_status_id,
                    deadline_quote: deadline_quote,
                    deadline_post: deadline_post,
                    deadline: deadline,
                }
            })
                .done(function (text) {
                    toastr.success('Данные сохранены');

                    if (fr_status_id == 3 || fr_status_id == 5 || fr_status_id == 6) {
                        let data = {
                            'users_id': user_id
                        }
                        socket.emit('eventPriority', data);
                        location.reload();

                    }


                });


        };

        if (document.getElementById('form-button-save-fixed')) {
            document.getElementById('form-button-save-fixed').addEventListener('click', () => {
                saveOrder();
            });
        }

        if (document.getElementById('form-button-save_view')) {
            document.getElementById('form-button-save_view').addEventListener('click', () => {
                saveOrder_view();
            });
        }

        if (document.getElementById('form-button-save')) {
            document.getElementById('form-button-save').addEventListener('click', () => {
                saveOrder();
            });

        }

        if (document.getElementById('form-button-save_commentar')) {
            document.getElementById('form-button-save_commentar').addEventListener('click', () => {
                saveOrderCommenter();
            });
        }


        $('#fr_script_id').change(() => {
            let fr_script_id = $('#fr_script_id').val();


            $.ajax({
                url: '/orders/getMaxScriptNum/',
                method: 'POST',
                data: {
                    fr_script_id: fr_script_id,

                }
            })
                .done(function (max) {
                    max = JSON.parse(max)
                    let val = +max.script_number + 1
                    $('#script_number').val(val);

                });


        });

        let role = `{{ role }}`;
        let user_id = `{{ user_id }}`;
        let department_id = `{{ department_id }}`;
        if ((role == '2' && user_id != 5) || role == '3' || role == '5' || role == '7' || role == '8') {
            let arrayInput = document.querySelectorAll('.form-control');
            [...arrayInput].forEach((el) => {

                if (el.id != 'fr_status_id') {
                    el.disabled = 'true';
                }

                if (el.id == 'fr_status_id' && role == '7') {
                    el.disabled = 'true';
                }

                if (el.id == 'deadline' || el.id == 'deadline_post' || el.id == 'deadline_quote') {
                    el.disabled = '';
                }

                if (el.id == 'inventory_sample' || el.id == 'inventory_alias') {
                    el.disabled = '';
                }

                if (document.getElementById('accordionExample18')) {
                    if (el.id == 'disease_filter') {
                        el.disabled = '';
                    }
                    if (el.id == 'biospecimen_type_filter') {
                        el.disabled = '';
                    }

                }

                if (department_id == '4') {
                    if (el.id == 'laboratory_sample'
                        || el.id == 'material_intake'
                        || el.id == 'expendable_materials'
                        || el.id == 'financial_expenses'
                        || el.id == 'material_intake_text'
                        || el.id == 'expendable_materials_text'
                        || el.id == 'financial_expenses_text'
                        || el.id == 'material_intake_num'
                        || el.id == 'expendable_materials_num'
                        || el.id == 'financial_expenses_num'
                    ) {
                        el.disabled = '';
                    }


                }


            })


        } else {

            if (role == '7') {

            }
            if (document.getElementById("form-button-save-fixed")) {
                document.getElementById("form-button-save-fixed").style.display = "block";
            }

        }

    })


    document.addEventListener('DOMContentLoaded', function () {

        var input = $('#file-input'), button = $('#file-submit'), container = $('#file-container')

        input.on('change', function () {
            let files = $(this).prop('files');
            for (let file of files) {
                let elem = $('<div class="file-info"><p>' + file.name + '</p><progress class="progress-bar" max="100" value="0"></progress></div>').appendTo(container);
                //добавляем инфу о файле в свойство превью
                elem.get(0).file = file;
            }
        })

        //асинхронный колбек закачки файлов
        button.on('click', async function (evt) {
            evt.preventDefault();
            //пускаем закачку каждого файла параллельно с помощью Promise.all и дожидаемся закачки всех файлов с помощью await.
            await Promise.all($('.file-info').map(upload));
        })

        //асинхронная функция закачки файла
        async function upload(index, elem) {
            let proj_id = `{{ fr.proj_id }}`, data = new FormData(), progress = $(elem).find('.progress-bar'),
                info = $("#file_info").val()
            data.append('file', elem.file)
            data.append('proj_id', proj_id)
            data.append('info', info)
            //ждем ответа об успешной обработке файла на стороне сервера
            const res = await $.ajax({
                url: '/orders/SaveFile',
                contentType: false,
                processData: false,
                data: data,
                type: 'post',
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.onprogress = function (evt) {
                        var percent = Math.ceil(evt.loaded / evt.total * 100);
                        progress.attr('value', percent);
                    }
                    return xhr;
                }
            }).done((data) => {
                toastr.info(data);
            });
        }
        {# async function upload_lto (index, elem) { #}
        {# let proj_id = `{{ fr.proj_id }}`; #}
        {# var data = new FormData(); #}
        {# data.append('file', elem.file); #}
        {# data.append('proj_id', proj_id); #}
        {# data.append('info', 'lto'); #}
        {# var progress = $(elem).find('.progress-bar'); #}
        {# //ждем ответа об успешной обработке файла на стороне сервера #}
        {# const res = await $.ajax({ #}
        {# url: '/orders/SaveFile', #}
        {# contentType: false, #}
        {# processData: false, #}
        {# data: data, #}
        {# type: 'post', #}
        {# xhr: function () { #}
        {# var xhr = new XMLHttpRequest(); #}
        {# xhr.upload.onprogress = function (evt) { #}
        {# var percent = Math.ceil(evt.loaded / evt.total * 100); #}
        {# progress.attr('value', percent); #}
        {# } #}
        {# return xhr; #}
        {# } #}
        {# }).done((data) => { #}
        {# toastr.info(data); #}
        {# }); #}
        {# } #}
    });

    document.addEventListener('DOMContentLoaded', function () {


        $('#inventory_save').click(() => {
            let sample = $('#inventory_sample').val();
            let alias = $('#inventory_alias').val();
            let id = $('#inventory_id').val();
            let comments = tinymce.get('inventory_comments').getContent();
            let proj_id = `{{ fr.proj_id }}`;
            if (sample == 0) {
                toastr.error('Нужно выбрать', 'Есть ли образец')
            } else {

                $.ajax({
                    url: '../../invertory/save/',
                    method: 'POST',
                    data: {
                        sample: sample,
                        alias: alias,
                        comments: comments,
                        proj_id: proj_id,
                        id: id,
                    }
                })
                    .done(function (result) {
                        if (result == 1) {
                            toastr.success('Инветори сохранен');
                            socket.emit('eventChangeStatusFRTABLE', proj_id);
                        } else {
                            toastr.error('Что-то пошло не так :)')
                        }
                    });

            }

        })


        $('#lavaratory_save').click(() => {
            let sample = $('#laboratory_sample').val();
            let id = $('#laboratory_id').val();
            let comments = tinymce.get('laboratory_comments').getContent();
            let proj_id = `{{ fr.proj_id }}`;

            let material_intake = $('#material_intake').val();
            let material_intake_text = $('#material_intake_text').val();
            let material_intake_num = $('#material_intake_num').val();

            let expendable_materials = $('#expendable_materials').val();
            let expendable_materials_text = $('#expendable_materials_text').val();
            let expendable_materials_num = $('#expendable_materials_num').val();

            let financial_expenses = $('#financial_expenses').val();
            let financial_expenses_text = $('#financial_expenses_text').val();
            let financial_expenses_num = $('#financial_expenses_num').val();


            if (sample == 0) {
                toastr.error('Нужно выбрать', 'Требуется процессинг/исследования');
            } else if (material_intake == 0) {
                toastr.error('Нужно выбрать', 'Потребуют дополнительный забора образца');
            } else if (expendable_materials == 0) {
                toastr.error('Нужно выбрать', 'Потребуют дополнительных расходных материалов');
            } else if (financial_expenses == 0) {
                toastr.error('Нужно выбрать', 'Потребуются дополнительные финансовые расходы');
            } else {

                $.ajax({
                    url: '../../laboratory/save/',
                    method: 'POST',
                    data: {
                        sample: sample,
                        comments: comments,
                        proj_id: proj_id,
                        id: id,

                        material_intake: material_intake,
                        material_intake_text: material_intake_text,
                        material_intake_num: material_intake_num,

                        expendable_materials: expendable_materials,
                        expendable_materials_text: expendable_materials_text,
                        expendable_materials_num: expendable_materials_num,

                        financial_expenses: financial_expenses,
                        financial_expenses_text: financial_expenses_text,
                        financial_expenses_num: financial_expenses_num,
                    }
                }).done(function (result) {
                    if (result == 1) {
                        toastr.success('ЛТО сохранен');
                        socket.emit('eventChangeStatusFRTABLE', proj_id);
                    } else {
                        toastr.error('Что-то пошло не так :)')
                    }
                });
            }
        })
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        $(".approval_comment_save").click((e) => {
            let El = $(e.currentTarget), id = El.attr('id').split('_')[1], comment = $(`#approvecomment_${id}`).val(),
                data = {id, comment}
            $.post({url: '/offerApproval/save/', data})
        })

        {# $(".approve_checkbox").change((e) => { #}
        {# let El = $(e.currentTarget), user_id = `{{ user_id }}`, id = El.attr('id').split('_')[1], #}
        {# approved = El.prop('checked') ? 1 : 0, offer_id = `{{ fr.proj_id }}`, #}
        {# data = {id, approved, user_id, offer_id} #}
        {# $.post({url: '/offerApproval/save/', data}) #}
        {# if (user_id === '1' && approved === 1) { #}
        {# /*let approvers = [4, 5, 56] #}
        {# approvers.forEach(approver_id => { #}
        {# let new_data = { #}
        {# offer_id: proj_id, #}
        {# user_id: approver_id #}
        {# } #}
        {# $.post({url: '/offerApproval/save/', data: new_data}) #}
        {# })*/ #}
        {# } #}
        {# }) #}
        $(".approve").click(e => {
            let El = $(e.currentTarget), user_id = `{{ user_id }}`, id = El.attr('id').split('_')[1],
                approved = 1, offer_id = `{{ fr.proj_id }}`,
                data = {id, approved, user_id, offer_id}
            $.post({url: '/offerApproval/save/', data}).done(() => {
                location.reload();
            })

        })
        $(".disapprove").click(e => {
            let El = $(e.currentTarget), user_id = `{{ user_id }}`, id = El.attr('id').split('_')[1],
                approved = 0, offer_id = `{{ fr.proj_id }}`,
                data = {id, approved, user_id, offer_id}
            $.post({url: '/offerApproval/save/', data}).done(() => {
                location.reload();
            })

        })

        $("#approval_request").click(() => {
            let proj_id = `{{ fr.proj_id }}`,
                data = {
                    offer_id: proj_id,
                    user_id: 1
                }
            $.post({url: '/offerApproval/save/', data}).done(() => {
                $("#approval_request").prop('disabled', 'true')
            })
        })

    })
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        $("#openTaskModal").click(() => {
            $("#offerTaskModal").modal('show')
        })
        $("#saveTask").click(() => {
            let data = {
                offer_id: `{{ fr.proj_id }}`,
                comment: $("#task_text").val(),
                status: $("#task_trigger_status").val()
            }
            $.post({
                url: '/offerStatusTrigger/checkOfferStatus',
                data
            }).then(res => {
                if (res === '1') {
                    $.post({
                        url: '/offerStatusTrigger/save',
                        data
                    }).then(response => {
                        toastr.success(response, 'Успешно');
                        $("#offerTaskModal").modal('hide')
                    })
                } else {
                    toastr.error('Ошибка', 'Статус уже установлен');
                }
            })
        })

        $.get({
            url: '/ordersStatus/getAll/'
        }).done((data) => {
            data = JSON.parse(data)
            for (let key in data.result) {
                if (['2', '3', '6', '7'].indexOf(data.result[key].department_id) !== -1 && data.result[key].status_name !== 'Отсутствует') {
                    $("#task_trigger_status").append(`<option value="${data.result[key].id}">${data.result[key].status_name}</option>`)
                }
            }
        })


        let deletBotton = document.querySelectorAll('.deleteFile');
        [...deletBotton].forEach(el => {
            el.addEventListener('click', (e) => {

                $.get({
                    url: '/file/delete/?id=' + e.target.dataset.id
                }).done((data) => {
                    document.getElementById('file_' + e.target.dataset.id).remove();
                    document.getElementById('btn_' + e.target.dataset.id).remove();
                })

            })
        })

    })
</script>

<script src="../../../js/dist/vue.js"></script>
<script src="../../../js/components/Orders/offer.js?v=1.16"></script>
<script src="../../../js/components/Orders/offer_ru.js?v=2.0.1"></script>
<script src="../../../js/components/Orders/offer_ru_mod.js?v=1.93"></script>
<script src="../../../js/components/Orders/ape_offer.js?v=1.04"></script>
<script src="../../../js/components/Orders/chat.js?v=1.04"></script>
<script src="../../../js/main.js"></script>

<script>
    $(document).ready(() => {

        function getBiotypes() {
            return new Promise(resolve => {
                $.post({
                    url: '/biospecimenType/getAll'
                }).then(data => {
                    resolve(JSON.parse(data))
                })
            });

        }

        function getMods() {
            return new Promise(resolve => {
                $.get('/sampleMod/getFresh').done(res => {
                    resolve(JSON.parse(res))
                })
            })
        }

        let Diseases = {{ order_diseases|json_encode|raw }}, DiseasesBiospecimenTypes = {}, DiseasesIds = [],
            BiotypesById = {}, DiseaseBiospecimen = [], Mods, ModsDatalist = ''

        async function loadDiseaseBiospecimenMods() {
            let Biotypes = await getBiotypes();
            Mods = await getMods();
            Mods.result.forEach(mod => {
                ModsDatalist += `<option value="${mod.modification}">${mod.modification}</option>`
            })

            Diseases.forEach((disease) => {
                DiseasesIds.push(disease.disease_id);
                let OrderDiseasesBiospecimenTypes = {{ diseases_biospecimen_types|json_encode|raw }}
                if (!DiseasesBiospecimenTypes[disease.disease_id])
                    DiseasesBiospecimenTypes[disease.disease_id] = []
                OrderDiseasesBiospecimenTypes.forEach(el => {
                    if (!DiseasesBiospecimenTypes[el.disease_id])
                        DiseasesBiospecimenTypes[el.disease_id] = []
                    if (DiseasesBiospecimenTypes[el.disease_id].indexOf(`${el.disease_id}_${el.biospecimen_type_id}`) === -1)
                        DiseasesBiospecimenTypes[el.disease_id].push(`${el.disease_id}_${el.biospecimen_type_id}`)
                })
                let biospecimen_types_datalist = $(`#biospecimen_types_select_${disease.disease_id}`)
                Biotypes.result.forEach(biotype => {
                    BiotypesById[biotype.id] = biotype.biospecimen_type;
                    biospecimen_types_datalist.append(`<option value="${biotype.biospecimen_type}" id="${disease.disease_id}_${biotype.id}">`)
                })
                OrderDiseasesBiospecimenTypes.forEach(diseases_biospecimen_type => {
                    if (diseases_biospecimen_type.disease_id === disease.disease_id) {
                        $(`#disease_biospecimen_types_${disease.disease_id}`).append(`<div class="row">
                                    <div class="col-2"></div>
                                    <div class="col-7">
                                        <button class="btn btn-block btn-info">${BiotypesById[diseases_biospecimen_type.biospecimen_type_id]}</button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-block btn-danger delete_biospecimen" dbid="${diseases_biospecimen_type.id}"
                                            id="delbio_${disease.disease_id}_${diseases_biospecimen_type.biospecimen_type_id}"
                                            {% if role != '1'  and role != '6' %} style="display: none;" {% endif %}>X</button>
                                    </div>
                                <div class="col-2">Modification</div>
                                <div class="col-6">
                                    <input list="sample_mod_select_${disease.disease_id}_${diseases_biospecimen_type.biospecimen_type_id}" class="form-control mod_input"
                                        id="sample_mod_input_${diseases_biospecimen_type.id}"
                                        value="${diseases_biospecimen_type.modification || ''}"
                                        {% if role != '1' and role != '6' %} disabled {% endif %}>
                                    <datalist id="sample_mod_select_${disease.disease_id}_${diseases_biospecimen_type.biospecimen_type_id}"
                                        class="sample_mod_select sample_mod_input_${diseases_biospecimen_type.id}"></datalist>
                                </div>
                                <div class="col-1">
                                    <input type="number" class="form-control" id="samplecount_${diseases_biospecimen_type.id}" value="${diseases_biospecimen_type.sample_count}" min="0">
                                </div>
                                <div class="col-3">
                                {% if role != '3' %}
                                    <button class="btn btn-block btn-success sample_mod_add" type="button"
                                        id="sample_mod_add_${disease.disease_id}_${diseases_biospecimen_type.biospecimen_type_id}"
                                        dbid="${diseases_biospecimen_type.id}">
                                        SAVE
                                    </button>
                                {% endif %}
                                </div>
                            </div>`)
                    }
                })
            })
            $(".mod_input").focus(e => {
                let ModInput = $(e.currentTarget), sampleid = ModInput.attr('id').split('_')[3],
                    Datalist = $(`.sample_mod_input_${sampleid}`)
                Datalist.html(ModsDatalist)
            })
        }

        loadDiseaseBiospecimenMods()

        $("#disease_add").click(() => {
            let disease_select = $("#disease_input"),
                disease_name = disease_select.val(),
                mutation = $(`#disease_select option[value="${disease_name}"]`).html(),
                disease_id = $(`#disease_select option[value="${disease_name}"]`).attr('id')
            if (disease_name && DiseasesIds.indexOf(disease_id) === -1) {
                DiseasesIds.push(disease_id)
                DiseasesBiospecimenTypes[disease_id] = []
                $("#diseases_list").append(`<div id="disease_biospecimen_types_${disease_id}" class="disease_block">
                    <div class="row">
                        <div class="col-9">
                            <button class="btn btn-block btn-info">${disease_name}<br> <span style="font-size:10px;">${mutation}</span></button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-block btn-danger delete_disease" id="deldisease_${disease_id}">X</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-7">
                            <input list="biospecimen_types_select_${disease_id}" class="form-control" id="biospecimen_types_input_${disease_id}">
                            <datalist id="biospecimen_types_select_${disease_id}"></datalist>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-block btn-success biospecimen_types_add" type="button" id="biospecimen_types_add_${disease_id}">
                                <i class="fa fa-plus"></i>
                                ADD
                            </button>
                        </div>
                    </div>
                </div>`)

                $.post({
                    url: '/orderDiseases/save/',
                    data: {
                        order_id: `{{ fr.proj_id }}`,
                        disease_id
                    }
                })
                $.post({
                    url: '/biospecimenType/getAll'
                }).then(data => {
                    let Biotypes = JSON.parse(data),
                        biospecimen_types_datalist = $(`#biospecimen_types_select_${disease_id}`)
                    Biotypes.result.forEach(biotype => {
                        biospecimen_types_datalist.append(`<option value="${biotype.biospecimen_type}" id="${disease_id}_${biotype.id}">`)
                    })
                })
            }
            disease_select.val('')
        })

        $('body').on('click', 'button.delete_biospecimen', function (e) {
            let id = $(e.currentTarget).attr('id'), disease_id = id.split('_')[1], biospecimen_id = id.split('_')[2],
                index = DiseasesBiospecimenTypes[disease_id].indexOf(`${disease_id}_${biospecimen_id}`)
            DiseasesBiospecimenTypes[disease_id].splice(index, 1)
            $(e.currentTarget).closest('.row').remove()
            let dbid = $(this).attr('dbid')
            if (typeof dbid !== 'undefined' && dbid !== false) {
                $.post({
                    url: '/diseasesBiospecimenTypes/delete',
                    data: {id: dbid}
                })
            }
        })

        $('body').on('click', 'button.delete_disease', function (e) {
            let id = $(e.currentTarget).attr('id'), disease_id = id.split('_')[1]
            if (DiseasesBiospecimenTypes[disease_id].length === 0) {
                delete DiseasesBiospecimenTypes[disease_id]
                delete DiseasesIds[DiseasesIds.indexOf(disease_id)]
                $(e.currentTarget).closest('.disease_block').remove()
                let dbid = $(this).attr('dbid')
                if (typeof dbid !== 'undefined' && dbid !== false) {
                    $.post({
                        url: '/orderDiseases/delete',
                        data: {id: dbid}
                    })
                }
            }
        })

        $('body').on('click', '.sample_mod_add', function (e) {
            let id = $(e.currentTarget).attr('id'), disease_id = id.split('_')[3],
                biospecimen_type_id = id.split('_')[4],
                dbid = $(e.currentTarget).attr('dbid'), modification = $(`#sample_mod_input_${dbid}`).val(),
                sample_count = $(`#samplecount_${dbid}`).val()

            $.post({
                url: '/sampleMod/getByMod',
                data: {modification}
            }).done(res => {
                let Mod = JSON.parse(res), mod_id
                if (!Mod.length) {
                    $.post({
                        url: '/sampleMod/save',
                        data: {modification}
                    }).done(res2 => {
                        mod_id = res2
                        $.post({
                            url: '/diseasesBiospecimenTypes/save/',
                            data: {
                                order_id: `{{ fr.proj_id }}`,
                                id: dbid,
                                mod_id, disease_id, biospecimen_type_id, modification, sample_count
                            }
                        })
                    })
                } else {
                    mod_id = Mod[0].id
                    $.post({
                        url: '/diseasesBiospecimenTypes/save/',
                        data: {
                            order_id: `{{ fr.proj_id }}`,
                            id: dbid,
                            mod_id, disease_id, biospecimen_type_id, modification, sample_count
                        }
                    })
                }
            })
        })

        $('body').on('click', '.biospecimen_types_add', (e) => {
            let disease_id = $(e.currentTarget).attr('id').split('_')[3],
                biospecimen_type_input = $(`#biospecimen_types_input_${disease_id}`),
                biospecimen_type = biospecimen_type_input.val(),
                biospecimen_type_id = $(`#biospecimen_types_select_${disease_id} option[value="${biospecimen_type}"]`).attr('id')
            if (!DiseasesBiospecimenTypes[disease_id]) {
                DiseasesBiospecimenTypes[disease_id] = []
            }
            if (biospecimen_type_id /*&& DiseasesBiospecimenTypes[disease_id].indexOf(biospecimen_type_id) === -1*/) {
                DiseasesBiospecimenTypes[disease_id].push(biospecimen_type_id)
                DiseaseBiospecimen.push(biospecimen_type_id)
                biospecimen_type_id = biospecimen_type_id.split('_')[1]
                $.post({
                    url: '/diseasesBiospecimenTypes/save/',
                    data: {
                        order_id: `{{ fr.proj_id }}`,
                        disease_id,
                        biospecimen_type_id,
                        modification: biospecimen_type
                    }
                }).done(dbid => {
                    $(`#disease_biospecimen_types_${disease_id}`).append(`<div class="row">
                                <div class="col-2"></div>
                                <div class="col-7">
                                    <button class="btn btn-block btn-info">${biospecimen_type}</button>
                                </div>
                                <div class="col-3">
                                    <button class="btn btn-block btn-danger delete_biospecimen" id="delbio_${disease_id}_${biospecimen_type_id}" dbid="${dbid}">X</button>
                                </div>
                                <div class="col-3">Modification</div>
                                <div class="col-6">
                                    <input list="sample_mod_select_${disease_id}_${biospecimen_type}" class="form-control"
                                        id="sample_mod_input_${dbid}">
                                    <datalist id="sample_mod_select_${disease_id}_${biospecimen_type}"
                                        class="sample_mod_select"></datalist>
                                </div>
                                <div class="col-3">
                                    <button class="btn btn-block btn-success sample_mod_add" type="button" id="sample_mod_add_${disease_id}_${biospecimen_type_id}" dbid="${dbid}">
                                        SAVE
                                    </button>
                                </div>
                            </div>`)
                    $.get('/sampleMod/getAll').done(res => {
                        let Mods = JSON.parse(res), modsOptions = Mods.result.reduce((acc, mod) => {
                            return acc + `<option value="${mod.modification}">${mod.modification}</option>`
                        }, '')
                        $(".sample_mod_select").html(modsOptions)
                    })
                })
            }
            biospecimen_type_input.val('')
        })

        let script_id = $('#fr_script_id').val()
        $.get({
            url: `/staff/GetByCompany/?script_id=${script_id}`
        }).done((result) => {
            let managers = (JSON.parse(result))['result'], attention_to = $("#fr_attention_to"),
                current_attention = `{{ fr.attention_to }}`
            attention_to.html('<option value="0">Выберите менеджера</option>')
            managers.forEach(manager => {
                attention_to.append(`<option value="${manager.id}" ${current_attention === manager.id ? 'selected' : ''}>
                    ${manager.name || ''} ${manager.position || ''}</option>`)
            })
        })

        $('#fr_script_id').change(() => {
            let script_id = $('#fr_script_id').val()
            $.get({
                url: `/staff/GetByCompany/?script_id=${script_id}`
            }).done((result) => {
                let managers = (JSON.parse(result))['result'], attention_to = $("#fr_attention_to"),
                    current_attention = {{ attention_to }}
                        attention_to.html('<option value="0">Веберите менеджера</option>')
                managers.forEach(manager => {
                    attention_to.append(`<option value="${manager.id}" ${current_attention == manager.id ? 'selected' : ''}>
                    ${manager.name || ''} ${manager.position || ''}</option>`)
                })
            })
        })

    })


    function delete_triger(id) {
        $.post({
            url: '/offerStatusTrigger/delete',
            data: {id: id}
        }).done(function (res) {
            $('#triger_' + id).remove();
        });
    }


</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let ChatModal = $("#chat_modal"), Chat = $("#chat_history"), order_id = parseInt(`{{ fr.proj_id }}`),
            ScreenTickets = {}, user_id = parseInt(`{{ user_id }}`), UserNamesById = {}

        $.get({url: '/users/getEverybody'}).done((res) => {
            let Users = JSON.parse(res)
            Users.data.forEach(user => {
                let fullname = `${user.lasttname} ${user.firstname} ${user.patronymic || ''}`;
                UserNamesById[user.id] = fullname
            })
        })

        $.get({url: '/newTickets/getByOrderId/', data: {order_id}}).done(res => {
            $("#my_tickets").empty()
            let MyTickets = JSON.parse(res)
            MyTickets.result.forEach(ticket => {
                let unviewedMessages
                let chat = ticket.chat
                if (chat && chat.length)
                    unviewedMessages = parseInt(chat[chat.length - 1].author_id) !== user_id
                else
                    unviewedMessages = parseInt(ticket.author_id) !== user_id
                if (ticket.done)
                    unviewedMessages = false
                let upDate = ticket.updated_at.split(' ')[0].split('-').reverse().join('/') + ' ' +
                    ticket.updated_at.split(' ')[1].split(':').slice(0, 2).join(':')
                $("#my_tickets").prepend(`
                            <div class='card ticket' id='tcard_${ticket.id}'>
                                <div class="card-header">
                                    <h3 id="ticketdetails_${ticket.id}" class="pull-left">${ticket.title}</h3>
                                    <button class="btn btn-round pull-right ${ticket.done ? 'btn-secondary' : 'btn-success'}">
                                        ${ticket.done ? '&times; Закрыт' : 'Открыт'}
                                    </button>
                                    ${unviewedMessages ? '<button class="btn btn-round pull-right btn-danger">Новые сообщения</button>' : ''}
                                </div>
                                <div class="card-body">
                                    <div class="pull-left">
                                        <p class="pull-left">
                                            От: ${UserNamesById[ticket.author_id]}<br>
                                            Кому: ${UserNamesById[ticket.target_id]}</p>
                                    </div>
                                    <div class="pull-right">
                                        Дата изменения ${upDate}
                                    </div>
                                </div>
                            </div>
                        `)
                ScreenTickets[ticket.id] = ticket
            })
            $(".ticket").off('click').click((e) => {
                let divPressed = $(e.currentTarget), tId = divPressed.attr('id').split('_')[1],
                    ticket = ScreenTickets[tId]
                $("#chat_modal_header_ticket_id").html(tId)
                Chat.html(ticket.message)
                let chat = ticket.chat
                chat.forEach((msg) => {
                    Chat.append(`
                                <div class="${parseInt(msg.author_id) === user_id ? 'ticket_my' : 'ticket_in'}">
                                    ${msg.message}
                                </div>
                                <div class="${parseInt(msg.author_id) === user_id ? 'ticket_author_my' : 'ticket_author_in'}">
                                    ${UserNamesById[msg.author_id]}
                                </div>
                                <div class="${parseInt(msg.author_id) === user_id ? 'ticket_date_my' : 'ticket_date_in'}">
                                    ${msg.created_at.split(' ')[0].split('-').reverse().join('/') + ' ' +
                    msg.created_at.split(' ')[1].split(':')[0] + ':' +
                    msg.created_at.split(' ')[1].split(':')[1]}
                                </div>
                                `)
                    if (parseInt(msg.author_id) !== user_id) {
                        $.post({url: '/newTicketChats/save/', data: {id: msg.id, viewed: 1}})
                    }
                })
                ChatModal.modal('show')
            })
        })
    })
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        $(".quote_info").click(e => {
            let btn = $(e.currentTarget), quote_id = btn.attr('id').split('_')[1], data = {id: quote_id},
                quotes_info_modal = $("#quotes_info_modal"), quote_info_rows = $("#quote_info_rows")
            $.post({url: '/quote/samplesInfo', data}).done(res => {
                quotes_info_modal.modal('show')
                quote_info_rows.empty()
                let Quotes = JSON.parse(res)
                Quotes.result.forEach(quote => {
                    let rowClass =
                        quote.status === 'deleted' ? 'alert-danger' :
                            quote.status === 'manual' ? 'alert-success' : 'alert-dark'
                    quote_info_rows.append(`
                        <div class="alert ${rowClass} mb-2" role="alert">
                            ${quote.biospecimen_type} <b>${quote.biospecimen_type_russian}</b> ${quote.mod ? quote.mod : ''}
                        </div>
                    `)
                })
            })
        })
    })
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        let ScreenTickets = {}, user_id = parseInt(`{{ user_id }}`), UserNamesById = {}, ScreenManagerTickets = {},
            role_id = parseInt(`{{ role_id }}`), ManagerResponsesTable = $("#manager_responses_table")

        $.get({url: '/users/getEverybody'}).done((res) => {
            let Users = JSON.parse(res)
            Users.data.forEach(user => {
                UserNamesById[user.id] = `${user.lasttname} ${user.firstname} ${user.patronymic || ''}`
            })
        })

        let refreshMyTickets = () => {
            ScreenManagerTickets = {}
            $.get({url: '/newTickets/getAll/'}).done(res => {
                $("#manager_tickets").empty()
                let MyTickets = JSON.parse(res)
                MyTickets.result.filter(t => t.reason === 'manager' || t.reason === 'none').forEach((ticket, i, TicketsArr) => {
                    if (ticket.reason === 'manager' && ticket.order_id === `{{ fr.proj_id }}`) {
                        let upDate = ticket.updated_at.split(' ')[0].split('-').reverse().join('/') + ' ' +
                            ticket.updated_at.split(' ')[1].split(':').slice(0, 2).join(':'),
                            crDate = ticket.created_at.split(' ')[0].split('-').reverse().join('/') + ' ' +
                                ticket.created_at.split(' ')[1].split(':').slice(0, 2).join(':'), ticketDisplayedTarget
                        if (!ScreenManagerTickets[`${ticket.order_id}_${ticket.title}`]) {
                            ScreenManagerTickets[`${ticket.order_id}_${ticket.title}`] = []
                            let ticketInfo, ticketBtn
                            if (role_id !== 3) {
                                ticketInfo = `
                                    <h5><a href="/orders/info/?idFR=${ticket.order_id}" target="_blank">Запрос № ${ticket.order_id} (${ticket.internal_id})</a></h5>
                                    <h5>${ticket.fr_date !== '' ? `Дата получения запроса: ${ticket.fr_date.split('-').reverse().join('/')}<br>` : ''}</h5>
                                    <h5>Дата дедлайна ${ticket.deadline.split('-').reverse().join('/')}</h5>
                                    <h4>${ticket.company_name !== '' ? `Компания: ${ticket.company_name}<br>` : ''}</h4>`
                                ticketDisplayedTarget = TicketsArr.filter((t) => {
                                    return t.order_id === ticket.order_id && t.title === ticket.title
                                }).reduce((acc, curVal) => {
                                    return acc + UserNamesById[parseInt(curVal.target_id)] + '; '
                                }, '<br>')
                                ticketBtn = `<button class="btn btn-round pull-right btn-secondary manager_responses" id="responses_${ticket.order_id}_${ticket.title}">Ответы</button>`
                            } else {
                                ticketInfo = `
                                    <h5><a href="/orders/info/?idFR=${ticket.order_id}" target="_blank">Запрос № ${ticket.order_id}</a></h5>
                                    <h5>Дата дедлайна ${ticket.deadline.split('-').reverse().join('/')}</h5>`
                                ticketDisplayedTarget = UserNamesById[parseInt(ticket.target_id)]
                                ticketBtn = `<a href="/newTickets/view/?id=${ticket.id}">
                                        <button class="btn btn-round pull-right btn-secondary">
                                            ${parseInt(ticket.done) ? '&times; Закрыт' : 'Открыт'}</button></a>`
                            }
                            $("#manager_tickets").prepend(`
                            <div class='card ticket ${ticket.priority === '1' ? 'gradient-pomegranate' : 'gradient-mint'}' id='tcard_${ticket.id}'
                                style='color:white;'>
                                <div class="card-header">
                                    <h3 class="pull-left">${ticket.title}</h3>
                                     ${ticketBtn}
                                </div>
                                <div class="card-body">
                                    ${ticketInfo}
                                    ${ticket.message}<br><br>
                                    От: ${UserNamesById[parseInt(ticket.author_id)]}<br>
                                    Кому:
                                        <table class="table">
                                            ${ticketDisplayedTarget}
                                        </table>
                                    <div class="pull-right">
                                        Дата получения ${crDate}<br>
                                        Дата изменения ${upDate}
                                    </div>
                                </div>
                            </div>
                            `)
                            ScreenManagerTickets[`${ticket.order_id}_${ticket.title}`].push(ticket)
                        } else {
                            ScreenManagerTickets[`${ticket.order_id}_${ticket.title}`].push(ticket)
                        }
                    }
                })
                $(".manager_responses").off('click').click(e => {
                    let btnPressed = $(e.currentTarget), btnId = btnPressed.attr('id'), idFrags = btnId.split('_'),
                        manTickId = `${idFrags[1]}_${idFrags[2]}`, tickIds = []
                    ManagerResponsesTable.empty()
                    $("#manager_responses_modal").modal('show')
                    ScreenManagerTickets[manTickId].forEach(mantick => {


                        // let msg = mantick.chat.length ? mantick.chat[mantick.chat.length - 1].message : '',
                        //     closeTickBtn
                        // if (msg)
                        //     msg += `<br>${mantick.chat[mantick.chat.length - 1].created_at.split(' ')[0].split('-').reverse().join('/')}`
                        //
                        //


                        let msg = '';
                        let data = {
                            'ticket_id': mantick.id
                        }


                        async function postData(url, data) {
                            // Default options are marked with *
                            const response = await fetch(url, {
                                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                                mode: 'cors', // no-cors, *cors, same-origin
                                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                                credentials: 'same-origin', // include, *same-origin, omit
                                headers: {
                                    'Content-Type': 'application/json'
                                    // 'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                redirect: 'follow', // manual, *follow, error
                                referrerPolicy: 'no-referrer', // no-referrer, *client
                                body: JSON.stringify(data) // body data type must match "Content-Type" header
                            });
                            return await response.json(); // parses JSON response into native JavaScript objects
                        }


                        postData('/TicketsScore/getInfobyTicketId/', data)
                            .then((data) => {
                                if (data.length > 0) {
                                    data.forEach(el => {
                                        msg += `<p style="font-size: 12px;">${el.action} <br> ${el.created_at}</p>`
                                    })
                                }


                                if (!mantick.done || mantick.done === '0') {
                                    closeTickBtn = `
                                <div class="display-inline-block">
                                    <select class="form-control" id="close_score_${mantick.id}">
                                        <option value="10">Все хорошо, задача закрывается</option>
                                        <option value="0">Задача не выполнена</option>
                                        <option value="5">Задача выполнена с опозданием</option>
                                    </select>
                                    <br>
                                    <button type="button" class="btn btn-danger close_manager_ticket" id="close_${mantick.id}">
                                        Закрыть</button>
                                    <button type="button" class="btn btn-secondary open_manager_ticket invisible" id="open_${mantick.id}">
                                        Открыть</button>
                                </div>
                                `
                                } else {
                                    closeTickBtn = `
                                <div class="display-inline-block">
                                    <select class="form-control invisible" id="close_score_${mantick.id}">
                                        <option value="10">Все хорошо, задача закрывается</option>
                                        <option value="0">Задача не выполнена</option>
                                        <option value="5">Задача выполнена с опозданием</option>
                                    </select>
                                    <br>
                                    ${mantick.closed_status === 'ok' ? 'Все хорошо, задача закрывается<br><br>' :
                                        (mantick.closed_status === 'late' ? 'Задача выполнена с опозданием<br><br>' :
                                            (mantick.closed_status === 'fail' ? 'Задача не выполнена<br><br>' : ''))}
                                    <button type="button" class="btn btn-danger close_manager_ticket invisible" id="close_${mantick.id}">
                                        Закрыть</button>
                                    <button type="button" class="btn btn-secondary open_manager_ticket" id="open_${mantick.id}">
                                        Открыть</button>
                                </div>`
                                }
                                ManagerResponsesTable.append(`<tr>
                            <td>${UserNamesById[mantick.target_id]}</td>
                            <td>${msg}</td>
                            <td>${mantick.chat ? mantick.chat.map(cmsg => cmsg.message).join('<br><br>') : ''}</td>
                            <td id="score_${mantick.id}">${mantick.done === '1' ? mantick.score : ''}</td>
                            <td>${closeTickBtn}</td>
                        </tr>`)
                                tickIds.push(mantick.id)

                                $(".close_manager_ticket").off('click').click(e => {
                                    let tId = $(e.currentTarget).attr('id').split('_')[1],
                                        score = $(`#close_score_${tId}`).val(), data = {id: tId, score: score, done: 1}
                                    $.post({url: '/newTickets/save/', data}).done((res) => {
                                        let Result = JSON.parse(res), newScore = Result.score
                                        $(`#score_${tId}`).html(newScore)
                                        $(`#close_${tId}, #open_${tId}, #close_score_${tId}`).toggleClass('invisible')
                                    })
                                })
                                $(".open_manager_ticket").off('click').click(e => {
                                    let tId = $(e.currentTarget).attr('id').split('_')[1], data = {id: tId, done: 0}
                                    $(`#score_${tId}`).html('')
                                    $.post({url: '/newTickets/save/', data}).done(() => {
                                        $(`#close_${tId}, #open_${tId}, #close_score_${tId}`).toggleClass('invisible')
                                    })
                                })
                                $("#close_manager_tickets").off('click').click(() => {
                                    tickIds.forEach((tId) => {
                                        $.post({url: '/newTickets/save/', data: {id: tId, done: 1}}).done(() => {
                                            location.reload()
                                        })
                                    })
                                })

                            })


                    })


                })
            })
        }

        refreshMyTickets()
    })
</script>
<script src="../../../app-assets/js/jquery.multi-select.js"></script>
<script src="../../../app-assets/js/jquery.quicksearch.js"></script>
<script>

    $(document).ready(() => {

        let TicketManagerSelect = $("#new_manager"), TicketDeadline = $("#new_deadline"), TicketTitle = $("#new_title")

        $.get({url: '/users/getManagers/'}).done(man_res => {
            let Managers = JSON.parse(man_res)
            Managers.result.forEach(Man => {
                let FullName = `${Man.firstname} ${Man.lasttname} ${Man.patronymic ? Man.patronymic : ''}`
                TicketManagerSelect.append(`<option value="${Man.id}">${FullName}</option>`)
            })
            TicketManagerSelect.multiSelect({
                cssClass: 'selector-container',
                selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Поиск'>",
                selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Поиск'>",
                afterInit: function (ms) {
                    let that = this,
                        $selectableSearch = that.$selectableUl.prev(),
                        $selectionSearch = that.$selectionUl.prev(),
                        selectableSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selectable:not(.ms-selected)',
                        selectionSearchString = '#' + that.$container.attr('id') + ' .ms-elem-selection.ms-selected';
                    that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                        .on('keydown', function (e) {
                            if (e.which === 40) {
                                that.$selectableUl.focus();
                                return false;
                            }
                        });
                    that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                        .on('keydown', function (e) {
                            if (e.which === 40) {
                                that.$selectionUl.focus();
                                return false;
                            }
                        });
                }
            })
        })

        let nextDay = new Date()
        nextDay.setDate(nextDay.getDate() + 2)
        let dd = nextDay.getDate(), mm = nextDay.getMonth() + 1, yyyy = nextDay.getFullYear(),
            dateVal
        mm = mm > 9 ? mm : '0' + mm
        dd = dd > 9 ? dd : '0' + dd
        dateVal = `${yyyy}-${mm}-${dd}`
        TicketDeadline.val(dateVal)

        $("#save_ticket").click(() => {
            let author_id = `{{ user_id }}`, title = TicketTitle.val(),
                message = tinymce.get('new_message').getContent(),
                deadline = TicketDeadline.val(), reason = 'manager',
                data = {author_id, title, message, deadline, reason, order_id: `{{ proj_id }}`},
                managers = TicketManagerSelect.val()
            managers.forEach(mId => {
                data.target_id = mId
                $.post({url: '/newTickets/save/', data}).done(() => {
                    location.reload()
                    // TicketTitle.val('')
                    // tinymce.get('new_message').setContent('')
                    // let nextDay = new Date()
                    // nextDay.setDate(nextDay.getDate() + 2)
                    // let dd = nextDay.getDate(), mm = nextDay.getMonth() + 1, yyyy = nextDay.getFullYear(),
                    //     dateVal
                    // mm = mm > 9 ? mm : '0' + mm
                    // dd = dd > 9 ? dd : '0' + dd
                    // dateVal = `${yyyy}-${mm}-${dd}`
                    // TicketDeadline.val(dateVal)
                    // TicketManagerSelect.multiSelect("refresh")
                })
            })
        })

    })

</script>
<script>
    function addWork() {
        if (window.confirm("Вы уверены, что хотите отправить биобанкам?")) {
            let data = {
                id: `{{ proj_id }}`
            }
            $.post({url: '../../worksheets/OnebyOneOrdersBiobank', data}).done(() => {
                toastr.success('Отправлено');
            })
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        let datatable = $('#HQTable').DataTable()


        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                let disease_id = $("#disease_filter").val(),
                    biospecimen_type_id = $("#biospecimen_type_filter").val()
                if (data[11] !== disease_id)
                    return false
                if (data[12] !== biospecimen_type_id)
                    return false
                return true
            }
        )

        $("#disease_filter, #biospecimen_type_filter").on('click change', () => {
            datatable.draw();
        })


        if (document.getElementById('send_fileQouteSend')) {
            document.getElementById('send_fileQouteSend').addEventListener('click', () => {
                let data = {
                    proj_id: `{{ proj_id }}`,
                    fileQouteSend: document.getElementById('fileQouteSend').value
                }
                $.post({url: '../../orders/save', data}).done(() => {
                    toastr.success('Отправлено');
                })
            });
        }


    })
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function filterManQuotes() {
            let managerSelected = $("#man_quote_manager_select").val(),
                diseaseSelected = $("#man_quote_disease_select").val()
            $("#man_quote_table>tbody>tr").each(function(i) {
                ((managerSelected === '0' || managerSelected === $(this).attr('manager')) &&
                    (diseaseSelected === '0' || diseaseSelected === $(this).attr('disease'))) ? $(this).show() : $(this).hide()
            })
        }
        $("#man_quote_manager_select, #man_quote_disease_select").change(filterManQuotes)
    })
</script>